<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>platforminfra.infrastructure.azure API documentation</title>
    <meta name="description" content="Azure Infrastructure module." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>


  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.getConfig">getConfig</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.getCredentials">getCredentials</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.getResources">getResources</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#platforminfra.infrastructure.azure.Azure">Azure</a></span>
        
          
  <ul>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.__init__">__init__</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.addDNS">addDNS</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.checkResourceExistById">checkResourceExistById</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.createResourceGroup">createResourceGroup</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.createStorageAccount">createStorageAccount</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.deleteDNSRecord">deleteDNSRecord</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.deleteResourceById">deleteResourceById</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.deleteStorageAccountContainer">deleteStorageAccountContainer</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.deleteStorageAccountDisk">deleteStorageAccountDisk</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.generateNicParams">generateNicParams</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.getDNSRecords">getDNSRecords</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.getResourceById">getResourceById</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.getResources">getResources</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.getStorageAccountKey">getStorageAccountKey</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.getStorageDisks">getStorageDisks</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.getSubnetID">getSubnetID</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.getVmInfo">getVmInfo</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.lbWorker">lbWorker</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.loadBalancer">loadBalancer</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.network">network</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.nic">nic</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.nsg">nsg</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.resourceGroupAvailable">resourceGroupAvailable</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.setConfig">setConfig</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.setId">setId</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.startVm">startVm</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.stopVm">stopVm</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.storageAccountAvailable">storageAccountAvailable</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.virtualMachine">virtualMachine</a></li>
    <li class="mono"><a href="#platforminfra.infrastructure.azure.Azure.vmWorker">vmWorker</a></li>
  </ul>

        </li>
      </ul>
    </li>

    <li class="set"><h3><a href="#header-submodules">Sub-modules</a></h3>
      <ul>
        <li class="mono"><a href="dependencies/index.html">platforminfra.infrastructure.azure.dependencies</a></li>
        <li class="mono"><a href="loadBalancer/index.html">platforminfra.infrastructure.azure.loadBalancer</a></li>
        <li class="mono"><a href="vm/index.html">platforminfra.infrastructure.azure.vm</a></li>
      </ul>
    </li>
    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">platforminfra.infrastructure.azure</span> module</h1>
  <p>Azure Infrastructure module.</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure" class="source">
    <pre><code>"""Azure Infrastructure module."""
# from .. import Infrastructure
from . import dependencies
from .vm import Vm
from .loadBalancer import LoadBalancer


from azure.common.credentials import ServicePrincipalCredentials
from azure.mgmt.resource import ResourceManagementClient
from azure.mgmt.storage import StorageManagementClient
from azure.mgmt.network import NetworkManagementClient
from azure.mgmt.compute import ComputeManagementClient
from azure.mgmt.dns import DnsManagementClient
from azure.storage.blob import BlockBlobService
from msrestazure.azure_exceptions import CloudError
from multiprocessing import Process, Queue, Lock
import re
import time


def getCredentials(config):
    """Given provider details Get the Credentials."""
    if 'provider' in config:
        for provider in config['provider']:
            if "azure" in provider:
                for details in provider['azure']:
                    if "config" in details:
                        for configItem in details['config']:
                            if "credentials" in configItem:
                                return configItem["credentials"]
                            else:
                                return {
                                    'error': 'No credentials in config'
                                }
                    else:
                        return {'error': 'No config found in Azure provider'}
            else:
                return {'error': 'No Azure provider details'}
        return {'error': 'No Credentials found for Azure'}
    else:
        return config


def getConfig(template):
    """Given provider details Get the Credentials."""
    for provider in template:
        if "azure" in provider:
            for details in provider['azure']:
                if "config" in details:
                    return details
                else:
                    return {'error': 'No config found in Azure provider'}
        else:
            return {'error': 'No Azure provider details'}


def getResources(template):
    """Given a list of Resources reply with an ordered Execution list."""
    deploymentOrder = {"resources": dependencies.getOrderedList(template)}
    return deploymentOrder


# class Azure(Infrastructure):
class Azure(object):
    """Azure class for Generic Azure operations."""

    def __init__(self, credentials, rg, sa, config=None, id=None):
        """The Azure Class."""
        # Infrastructure.__init__(self, 'Azure')
        self.setConfig(credentials, config)
        self.resourceGroup = rg
        self.storageAccount = sa
        if id:
            self.setId(id)
        self.apiVersions = {
            'Microsoft.Network/virtualNetworks': '2017-03-01',
            'Microsoft.Compute/availabilitySets': '2017-03-30',
            'Microsoft.Compute/virtualMachines': '2017-03-30',
            'Microsoft.Network/networkInterfaces': '2016-09-01',
            'Microsoft.Network/networkSecurityGroups': '2017-03-01',
            'Microsoft.Network/publicIPAddresses': '2017-03-01',
            'Microsoft.Network/loadBalancers': '2017-03-01'
        }

    def setConfig(self, credentials, config):
        """Set the config."""
        if config:
            self.credentials = getCredentials(config)
            self.config = getConfig(config['provider'])
            self.resources = getResources(config['services'])
        else:
            self.credentials = getCredentials(credentials)

        self.authAccount = ServicePrincipalCredentials(
            client_id=self.credentials['client_id'],
            secret=self.credentials['secret'],
            tenant=self.credentials['tenant']
        )

    def setId(self, id):
        """Set the Id."""
        self.id = id

    def getDNSRecords(self, id, domain="dev.temenos.cloud"):
        """Get DNS Records by ID."""
        dnsClient = DnsManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        records = dnsClient.record_sets.list_by_type(
            "mp_dev_core",
            domain,
            'A'
        )
        results = list()
        for record in records:
            if id == re.split(r"-", record.name.strip())[-1]:
                results.append(record.name)
        return results

    def deleteDNSRecord(self, records, domain="dev.temenos.cloud"):
        """Delete a record from the domain."""
        dnsClient = DnsManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        try:
            for record in records:
                dnsClient.record_sets.delete(
                    "mp_dev_core",
                    domain,
                    record,
                    'A'
                )
        except CloudError as e:
            raise Exception(e)

    def getStorageDisks(self, id, filter):
        """Get a list of Storage disks."""
        saKey = self.getStorageAccountKey()
        disks = list()
        blockBlobService = BlockBlobService(
            account_name=self.storageAccount,
            account_key=saKey
        )
        found = False
        containers = blockBlobService.list_containers()
        for container in containers:
            if id == container.name:
                found = True
        if found:
            blobs = blockBlobService.list_blobs(id)
            for blob in blobs:
                if filter:
                    search = ''.join(e for e in filter['value'] if e.isalnum())
                    if search in blob.name:
                        disks.append(blob.name)
                else:
                    disks.append(blob.name)
        return disks

    def getStorageAccountKey(self):
        """Return a Storage account Key."""
        strClient = StorageManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        saKeys = strClient.storage_accounts.list_keys(
            self.resourceGroup,
            self.storageAccount
        )
        return saKeys.keys[0].value

    def deleteStorageAccountDisk(self, containerName, disks):
        """Delete a storage Blob."""
        blockBlobService = BlockBlobService(
            account_name=self.storageAccount,
            account_key=self.getStorageAccountKey()
        )
        found = False
        containers = blockBlobService.list_containers()
        for container in containers:
            if containerName == container.name:
                found = True
        if found:
            try:
                for disk in disks:
                    blockBlobService.delete_blob(
                        containerName,
                        disk
                    )
            except Exception as e:
                raise Exception(e)

    def deleteStorageAccountContainer(self, containerName):
        """Delete a storage Blob."""
        blockBlobService = BlockBlobService(
            account_name=self.storageAccount,
            account_key=self.getStorageAccountKey()
        )
        found = False
        containers = blockBlobService.list_containers()
        for container in containers:
            if containerName == container.name:
                found = True
        if found:
            deleting = True
            retries = 0
            while deleting and retries < 10:
                try:
                    blockBlobService.delete_container(containerName)
                    deleting = False
                except:
                    time.sleep(10)

    def deleteResourceById(self, ids):
        """Delete a Resource by it's ID."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        retry = ids.copy()
        count = 0
        previousIds = list()
        while retry and count < 20:
            for id in retry:
                idSplit = re.split(r"/", id.strip())
                resourceType = idSplit[6] + "/" + idSplit[7]
                try:
                    result = resClient.resources.delete_by_id(
                        id,
                        self.apiVersions[resourceType]
                    )
                    result.wait()
                    retry.remove(id)
                except Exception as e:
                    if id in previousIds:
                        count = count + 1
                    else:
                        previousIds.append(id)
                    print("Adding resource to retry list: {}".format(id))

    def getResources(self, id=None, filter=None):
        """Get all resources."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        filterStr = str()
        if id:
            filterStr = "tagname eq 'uuid' and tagvalue eq '{}'".format(id)
            if filter:
                filterStr = " tagname eq '{key}' and tagvalue eq '{value}'"\
                    .format(**filter)

            resourceList = resClient.resources.list(
                filter=filterStr
            )
            resources = dict()
            ids = list()
            try:
                for page in resourceList.next():
                    if filter:
                        if id in page.id:
                            ids.append(page.id)
                    else:
                        ids.append(page.id)
                if ids:
                    resources["ids"] = ids
                dnsEntries = self.getDNSRecords(id)
                if dnsEntries:
                    resources["dns"] = dnsEntries
                disks = self.getStorageDisks(id, filter)
                if disks:
                    resources["vhds"] = disks

            except CloudError as e:
                # TODO: Decide to raiseor not, not frequently happening.
                print("Error: {}".format(e))
                pass
            return resources
        else:
            filterStr = "tagname eq 'uuid'"
            resourceList = resClient.resource_groups.list_resources(
                self.resourceGroup,
                filter=filterStr
            )
            ids = set()
            try:
                for page in resourceList.next():
                    resource = self.getResourceById(page.type, page.id)
                    ids.add(resource.tags['uuid'])
            except CloudError as e:
                # TODO: Decide to raise or not, Not frequently happening
                print("Error: {}".format(e))
                pass
            return list(ids)

    def checkResourceExistById(self, type, id):
        """Check if a resource Exists by Id."""
        result = False
        try:
            self.getResourceById(type, id)
            result = True
        except:
            pass
        return result

    def getResourceById(self, type, id):
        """Get a resource by ID."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = resClient.resources.get_by_id(
            id,
            self.apiVersions[type]
        )
        return result

    def resourceGroupAvailable(self, rg):
        """Test to See if TG is available."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = resClient.resource_groups.check_existence(rg)
        return result

    def createResourceGroup(self):
        """Create a RG if not already created."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        if not self.resourceGroupAvailable(self.resourceGroup):
            resClient.resource_groups.create_or_update(
              self.resourceGroup,
              {
                'location': self.config['region']
              }
            )
        return self.resourceGroup

    def addDNS(self, ip, record, domain='dev.temenos.cloud'):
        """Add DNS Record."""
        print("Adding DNS Record")
        dnsClient = DnsManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        try:
            dnsClient.record_sets.create_or_update(
                "mp_dev_core",
                domain,
                record,
                'A',
                {
                    "ttl": 300,
                    "arecords": [{
                        "ipv4_address": ip
                    }]
                }
            )
        except CloudError as e:
            raise Exception(e)

        return record + "." + domain

    def storageAccountAvailable(self):
        """Test to see if a SA is available."""
        strClient = StorageManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        availability = strClient.storage_accounts.check_name_availability(
            self.storageAccount
        )
        return availability.name_available

    def createStorageAccount(self):
        """Create a SA if not already created."""
        strClient = StorageManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        if self.storageAccountAvailable():
            saAsyncOp = strClient.storage_accounts.create(
              self.resourceGroup,
              self.storageAccount,
              {
                'sku': {'name': 'standard_lrs'},
                'kind': 'storage',
                'location': self.config['region']
              }
            )
            saAsyncOp.wait()

    def getVmInfo(self, vmName, id, rg):
        """Get Extended info about a VM."""
        cmpClient = ComputeManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = cmpClient.virtual_machines.get(rg, vmName, "instanceView")
        return result

    def stopVm(self, vmName, rg):
        """Stop a VM."""
        cmpClient = ComputeManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = cmpClient.virtual_machines.power_off(rg, vmName)
        return result

    def startVm(self, vmName, rg):
        """Sart a VM."""
        cmpClient = ComputeManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = cmpClient.virtual_machines.start(rg, vmName)
        return result

    def getSubnetID(self, netName):
        """Get the Subnets for a network."""
        netClient = NetworkManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        subFound = False
        netFound = False
        try:
            network = netClient.virtual_networks.get(
                self.resourceGroup,
                netName
            )
            if network.provisioning_state == 'Succeeded':
                netFound = True
            if len(network.subnets) != 0:
                subFound = True
        except:
            pass

        if not netFound:
            return {'error': "No network of name: {}".format(netName)}
        if not subFound:
            return {'error': "No Subnets foing in network: {}".format(netName)}

        return network.subnets[0]

    def network(self, network, netName, tags, subNets, errors):
        """Create networks."""
        try:
            netClient = NetworkManagementClient(
                self.authAccount, self.credentials['subscription_id']
            )
            params = {
               'location': self.config['region'],
               'address_space': {
                 'address_prefixes': [network['cidr']]
               }
            }
            if len(tags) > 0:
                params["tags"] = tags

            subFound = False
            netFound = False
            try:
                network = netClient.virtual_networks.get(
                    self.resourceGroup,
                    netName
                )
                if network.provisioning_state == 'Succeeded':
                    netFound = True
                if len(network.subnets) != 0:
                    subFound = True
            except:
                pass

            if not netFound:
                asyncNetCreation = netClient.virtual_networks.create_or_update(
                  self.resourceGroup,
                  netName,
                  params
                )
                asyncNetCreation.wait()
            # This will need to loop if we want more than 1 subnet per network
            if not subFound:
                subNetName = netName + "sub1"
                asyncSubnetCreation = netClient.subnets.create_or_update(
                  self.resourceGroup,
                  netName,
                  subNetName,
                  {'address_prefix': network['subnet']}
                )
                asyncSubnetCreation.wait()
                subNets.put({
                    self.id: asyncSubnetCreation.result()
                })
            else:
                subNets.put({
                    self.id: network.subnets[0]
                })
        except Exception as e:
            print("Error creating network {}".format(str(e)))
            errors.put(Exception(e))

    def nsg(self, vm, tags):
        """Create NSG."""
        netClient = NetworkManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        nsgName = self.id + vm['name'] + "Nsg"
        rules = {
          "location": self.config['region'],
          "security_rules": [
            {
              "description": "SSH Access",
              "protocol": "Tcp",
              "source_port_range": "*",
              "source_address_prefix": "*",
              "destination_address_prefix": "*",
              "destination_port_range": "22",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound",
              "name": nsgName + "-22-nsg"
            },
            {
              "description": nsgName + "-" + str(vm['service_port']),
              "protocol": "Tcp",
              "source_port_range": "*",
              "source_address_prefix": "*",
              "destination_address_prefix": "*",
              "destination_port_range": str(vm['service_port']),
              "access": "Allow",
              "priority": 110,
              "direction":"Inbound",
              "name": nsgName + "-" + str(vm['service_port']) + "-nsg"
            }
          ]
        }
        if len(tags) > 0:
            rules["tags"] = tags
        nsgCreated = False
        try:
            asyncNsgOp = netClient.network_security_groups.get(
                self.resourceGroup,
                nsgName
            )
            asyncNsgOp.wait()
            nsg = asyncNsgOp.result()
            return nsg
        except Exception:
            pass
        if not nsgCreated:
            aNsgOp = netClient \
                .network_security_groups.create_or_update(
                    self.resourceGroup,
                    nsgName,
                    rules
                )
            aNsgOp.wait()
            nsg = aNsgOp.result()
            return nsg

    def generateNicParams(self, vm, vmName, subnet, pubIP, tags):
        """Generate the Nic Parameters."""
        params = {
            'location': self.config['region'],
          }
        ipConfig = [{
          'name': vmName + '-nic',
          'subnet': {
            'id': subnet.id
          },
          'public_ip_address': {
            'id': pubIP.id
          }
        }]
        if len(tags) > 0:
            params["tags"] = tags

        if 'service_port' in vm:
            nsg = self.nsg(vm, tags)
            params['network_security_group'] = nsg
        if 'beId' in vm:
            ipConfig[0]['load_balancer_backend_address_pools'] = [{
                'id': vm['beId']
            }]

        params['ip_configurations'] = ipConfig
        return params

    def nic(self, vm, vmName, subnet, tags):
        """Create a Network interface for a vm."""
        netClient = NetworkManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        pubIPName = vmName + "pubip"
        pubIpParams = {
          'public_ip_allocation_method': 'Dynamic',
          'location': self.config['region'],
          'public_ip_address_version': 'IPv4',
        }
        if len(tags) > 0:
            pubIpParams['tags'] = tags

        try:
            asycPubIPCreation = netClient.public_ip_addresses.create_or_update(
              self.resourceGroup,
              pubIPName,
              pubIpParams
            )
            asycPubIPCreation.wait()
            pubIP = asycPubIPCreation.result()
            nicParams = self.generateNicParams(vm, vmName, subnet, pubIP, tags)
            asyncNicCreation = netClient.network_interfaces.create_or_update(
              self.resourceGroup,
              vmName + "nic",
              nicParams
            )
        except:
            raise
        details = dict()
        details['public_ip_name'] = pubIPName
        details['nic'] = asyncNicCreation.result()
        return details

    def vmWorker(
                self, opts, vm, vmName, tags, asInfo, subnet, vmQ, errorQ,
                lock, persistData
            ):
        """Worker to create a VM."""
        tmpVm = Vm(opts)
        if 'os' in vm:
            os = vm['os']
        else:
            os = dict()
        if 'image' in vm:
            image = vm['image']
        else:
            image = dict()

        lock.acquire()
        vmNic = self.nic(vm, vmName, subnet, tags)
        lock.release()
        tmpDict = {'type': vm['name']}
        tmpVm.generateParams(
            vmNic['nic'].id,
            vmName,
            asInfo.id,
            {**tags, **tmpDict},
            persistData,
            os,
            image
        )
        tmpVm.create(vmName, vmNic, vmQ, errorQ)
        print("{} VM Created".format(vmName))

    def virtualMachine(
                self, vm, tags, subnet, vmQueue, vmLock, errors,
                persistData=False,
            ):
        """Create a VM."""
        try:
            print("Creating VMs: {}".format(vm['name']))
            vmLock.acquire()
            cmpClient = ComputeManagementClient(
                self.authAccount, self.credentials['subscription_id']
            )
            asName = self.id + '-as' + vm['name']
            try:
                asInfo = cmpClient.availability_sets.create_or_update(
                  self.resourceGroup,
                  asName,
                  {
                    'location': self.config['region'],
                    'tags': tags
                  }
                )
            except Exception as e:
                print("Passing Exception {}".format(e))
                pass
            vmLock.release()
            vmProcList = list()
            opts = dict()
            opts['config'] = self.config
            opts['sa'] = self.storageAccount
            opts['rg'] = self.resourceGroup
            opts['authAccount'] = self.authAccount
            opts['credentials'] = self.credentials
            vmQ = Queue()
            errorQ = Queue()
            lock = Lock()
            results = list()
            i = 1
            if 'existing' in vm:
                i = len(vm['existing']) + 1
            while i <= vm['count']:
                tmpStr = self.id + vm['name'] + str(i)
                vmName = ''.join(e for e in tmpStr if e.isalnum())
                print("Creating {}".format(vmName))
                p = Process(
                    target=self.vmWorker,
                    args=(
                        opts, vm, vmName, tags, asInfo, subnet, vmQ, errorQ,
                        lock, persistData
                    )
                )
                vmProcList.append(p)
                p.start()
                i = i + 1
            for proc in vmProcList:
                # Wait for all VM's to create
                proc.join(400)
                if not errorQ.empty():
                    # If it's not empty there's an error
                    raise Exception({
                        'error': "Error in VmWorker process: {}"
                        .format(errors.get()),
                        'code': 500
                    })
                if vmQ.empty():
                    # There should be items on the queue else it either
                    # Failed or timed-out
                    raise Exception({
                        'error': "Time out creating VM",
                        'code': 500
                    })
                else:
                    results.append(vmQ.get())

            vmQueue.put({'servers': vm['name'], 'vms': results})
        except Exception as e:
            print("Caught exception inside VM {}".format(str(e)))
            errors.put(Exception(e))
            pass

    def lbWorker(self, opts, lb, tags):
        """Worker to create a LB."""
        tmpLb = LoadBalancer(opts, lb, tags)
        result = tmpLb.create()
        return result

    def loadBalancer(self, lb, tags):
        """Create Load Balancer."""
        opts = dict()
        opts['config'] = self.config
        opts['sa'] = self.storageAccount
        opts['rg'] = self.resourceGroup
        opts['authAccount'] = self.authAccount
        opts['credentials'] = self.credentials

        return self.lbWorker(opts, lb, tags)
</code></pre>
  </div>

  </header>

  <section id="section-items">

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.getConfig">
    <p>def <span class="ident">getConfig</span>(</p><p>template)</p>
    </div>
    

    
  
    <div class="desc"><p>Given provider details Get the Credentials.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.getConfig', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.getConfig" class="source">
    <pre><code>def getConfig(template):
    """Given provider details Get the Credentials."""
    for provider in template:
        if "azure" in provider:
            for details in provider['azure']:
                if "config" in details:
                    return details
                else:
                    return {'error': 'No config found in Azure provider'}
        else:
            return {'error': 'No Azure provider details'}
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.getCredentials">
    <p>def <span class="ident">getCredentials</span>(</p><p>config)</p>
    </div>
    

    
  
    <div class="desc"><p>Given provider details Get the Credentials.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.getCredentials', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.getCredentials" class="source">
    <pre><code>def getCredentials(config):
    """Given provider details Get the Credentials."""
    if 'provider' in config:
        for provider in config['provider']:
            if "azure" in provider:
                for details in provider['azure']:
                    if "config" in details:
                        for configItem in details['config']:
                            if "credentials" in configItem:
                                return configItem["credentials"]
                            else:
                                return {
                                    'error': 'No credentials in config'
                                }
                    else:
                        return {'error': 'No config found in Azure provider'}
            else:
                return {'error': 'No Azure provider details'}
        return {'error': 'No Credentials found for Azure'}
    else:
        return config
</code></pre>
  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.getResources">
    <p>def <span class="ident">getResources</span>(</p><p>template)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a list of Resources reply with an ordered Execution list.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.getResources', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.getResources" class="source">
    <pre><code>def getResources(template):
    """Given a list of Resources reply with an ordered Execution list."""
    deploymentOrder = {"resources": dependencies.getOrderedList(template)}
    return deploymentOrder
</code></pre>
  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="platforminfra.infrastructure.azure.Azure" class="name">class <span class="ident">Azure</span></p>
      
  
    <div class="desc"><p>Azure class for Generic Azure operations.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure" class="source">
    <pre><code>class Azure(object):
    """Azure class for Generic Azure operations."""

    def __init__(self, credentials, rg, sa, config=None, id=None):
        """The Azure Class."""
        # Infrastructure.__init__(self, 'Azure')
        self.setConfig(credentials, config)
        self.resourceGroup = rg
        self.storageAccount = sa
        if id:
            self.setId(id)
        self.apiVersions = {
            'Microsoft.Network/virtualNetworks': '2017-03-01',
            'Microsoft.Compute/availabilitySets': '2017-03-30',
            'Microsoft.Compute/virtualMachines': '2017-03-30',
            'Microsoft.Network/networkInterfaces': '2016-09-01',
            'Microsoft.Network/networkSecurityGroups': '2017-03-01',
            'Microsoft.Network/publicIPAddresses': '2017-03-01',
            'Microsoft.Network/loadBalancers': '2017-03-01'
        }

    def setConfig(self, credentials, config):
        """Set the config."""
        if config:
            self.credentials = getCredentials(config)
            self.config = getConfig(config['provider'])
            self.resources = getResources(config['services'])
        else:
            self.credentials = getCredentials(credentials)

        self.authAccount = ServicePrincipalCredentials(
            client_id=self.credentials['client_id'],
            secret=self.credentials['secret'],
            tenant=self.credentials['tenant']
        )

    def setId(self, id):
        """Set the Id."""
        self.id = id

    def getDNSRecords(self, id, domain="dev.temenos.cloud"):
        """Get DNS Records by ID."""
        dnsClient = DnsManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        records = dnsClient.record_sets.list_by_type(
            "mp_dev_core",
            domain,
            'A'
        )
        results = list()
        for record in records:
            if id == re.split(r"-", record.name.strip())[-1]:
                results.append(record.name)
        return results

    def deleteDNSRecord(self, records, domain="dev.temenos.cloud"):
        """Delete a record from the domain."""
        dnsClient = DnsManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        try:
            for record in records:
                dnsClient.record_sets.delete(
                    "mp_dev_core",
                    domain,
                    record,
                    'A'
                )
        except CloudError as e:
            raise Exception(e)

    def getStorageDisks(self, id, filter):
        """Get a list of Storage disks."""
        saKey = self.getStorageAccountKey()
        disks = list()
        blockBlobService = BlockBlobService(
            account_name=self.storageAccount,
            account_key=saKey
        )
        found = False
        containers = blockBlobService.list_containers()
        for container in containers:
            if id == container.name:
                found = True
        if found:
            blobs = blockBlobService.list_blobs(id)
            for blob in blobs:
                if filter:
                    search = ''.join(e for e in filter['value'] if e.isalnum())
                    if search in blob.name:
                        disks.append(blob.name)
                else:
                    disks.append(blob.name)
        return disks

    def getStorageAccountKey(self):
        """Return a Storage account Key."""
        strClient = StorageManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        saKeys = strClient.storage_accounts.list_keys(
            self.resourceGroup,
            self.storageAccount
        )
        return saKeys.keys[0].value

    def deleteStorageAccountDisk(self, containerName, disks):
        """Delete a storage Blob."""
        blockBlobService = BlockBlobService(
            account_name=self.storageAccount,
            account_key=self.getStorageAccountKey()
        )
        found = False
        containers = blockBlobService.list_containers()
        for container in containers:
            if containerName == container.name:
                found = True
        if found:
            try:
                for disk in disks:
                    blockBlobService.delete_blob(
                        containerName,
                        disk
                    )
            except Exception as e:
                raise Exception(e)

    def deleteStorageAccountContainer(self, containerName):
        """Delete a storage Blob."""
        blockBlobService = BlockBlobService(
            account_name=self.storageAccount,
            account_key=self.getStorageAccountKey()
        )
        found = False
        containers = blockBlobService.list_containers()
        for container in containers:
            if containerName == container.name:
                found = True
        if found:
            deleting = True
            retries = 0
            while deleting and retries < 10:
                try:
                    blockBlobService.delete_container(containerName)
                    deleting = False
                except:
                    time.sleep(10)

    def deleteResourceById(self, ids):
        """Delete a Resource by it's ID."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        retry = ids.copy()
        count = 0
        previousIds = list()
        while retry and count < 20:
            for id in retry:
                idSplit = re.split(r"/", id.strip())
                resourceType = idSplit[6] + "/" + idSplit[7]
                try:
                    result = resClient.resources.delete_by_id(
                        id,
                        self.apiVersions[resourceType]
                    )
                    result.wait()
                    retry.remove(id)
                except Exception as e:
                    if id in previousIds:
                        count = count + 1
                    else:
                        previousIds.append(id)
                    print("Adding resource to retry list: {}".format(id))

    def getResources(self, id=None, filter=None):
        """Get all resources."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        filterStr = str()
        if id:
            filterStr = "tagname eq 'uuid' and tagvalue eq '{}'".format(id)
            if filter:
                filterStr = " tagname eq '{key}' and tagvalue eq '{value}'"\
                    .format(**filter)

            resourceList = resClient.resources.list(
                filter=filterStr
            )
            resources = dict()
            ids = list()
            try:
                for page in resourceList.next():
                    if filter:
                        if id in page.id:
                            ids.append(page.id)
                    else:
                        ids.append(page.id)
                if ids:
                    resources["ids"] = ids
                dnsEntries = self.getDNSRecords(id)
                if dnsEntries:
                    resources["dns"] = dnsEntries
                disks = self.getStorageDisks(id, filter)
                if disks:
                    resources["vhds"] = disks

            except CloudError as e:
                # TODO: Decide to raiseor not, not frequently happening.
                print("Error: {}".format(e))
                pass
            return resources
        else:
            filterStr = "tagname eq 'uuid'"
            resourceList = resClient.resource_groups.list_resources(
                self.resourceGroup,
                filter=filterStr
            )
            ids = set()
            try:
                for page in resourceList.next():
                    resource = self.getResourceById(page.type, page.id)
                    ids.add(resource.tags['uuid'])
            except CloudError as e:
                # TODO: Decide to raise or not, Not frequently happening
                print("Error: {}".format(e))
                pass
            return list(ids)

    def checkResourceExistById(self, type, id):
        """Check if a resource Exists by Id."""
        result = False
        try:
            self.getResourceById(type, id)
            result = True
        except:
            pass
        return result

    def getResourceById(self, type, id):
        """Get a resource by ID."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = resClient.resources.get_by_id(
            id,
            self.apiVersions[type]
        )
        return result

    def resourceGroupAvailable(self, rg):
        """Test to See if TG is available."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = resClient.resource_groups.check_existence(rg)
        return result

    def createResourceGroup(self):
        """Create a RG if not already created."""
        resClient = ResourceManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        if not self.resourceGroupAvailable(self.resourceGroup):
            resClient.resource_groups.create_or_update(
              self.resourceGroup,
              {
                'location': self.config['region']
              }
            )
        return self.resourceGroup

    def addDNS(self, ip, record, domain='dev.temenos.cloud'):
        """Add DNS Record."""
        print("Adding DNS Record")
        dnsClient = DnsManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        try:
            dnsClient.record_sets.create_or_update(
                "mp_dev_core",
                domain,
                record,
                'A',
                {
                    "ttl": 300,
                    "arecords": [{
                        "ipv4_address": ip
                    }]
                }
            )
        except CloudError as e:
            raise Exception(e)

        return record + "." + domain

    def storageAccountAvailable(self):
        """Test to see if a SA is available."""
        strClient = StorageManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        availability = strClient.storage_accounts.check_name_availability(
            self.storageAccount
        )
        return availability.name_available

    def createStorageAccount(self):
        """Create a SA if not already created."""
        strClient = StorageManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        if self.storageAccountAvailable():
            saAsyncOp = strClient.storage_accounts.create(
              self.resourceGroup,
              self.storageAccount,
              {
                'sku': {'name': 'standard_lrs'},
                'kind': 'storage',
                'location': self.config['region']
              }
            )
            saAsyncOp.wait()

    def getVmInfo(self, vmName, id, rg):
        """Get Extended info about a VM."""
        cmpClient = ComputeManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = cmpClient.virtual_machines.get(rg, vmName, "instanceView")
        return result

    def stopVm(self, vmName, rg):
        """Stop a VM."""
        cmpClient = ComputeManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = cmpClient.virtual_machines.power_off(rg, vmName)
        return result

    def startVm(self, vmName, rg):
        """Sart a VM."""
        cmpClient = ComputeManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        result = cmpClient.virtual_machines.start(rg, vmName)
        return result

    def getSubnetID(self, netName):
        """Get the Subnets for a network."""
        netClient = NetworkManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        subFound = False
        netFound = False
        try:
            network = netClient.virtual_networks.get(
                self.resourceGroup,
                netName
            )
            if network.provisioning_state == 'Succeeded':
                netFound = True
            if len(network.subnets) != 0:
                subFound = True
        except:
            pass

        if not netFound:
            return {'error': "No network of name: {}".format(netName)}
        if not subFound:
            return {'error': "No Subnets foing in network: {}".format(netName)}

        return network.subnets[0]

    def network(self, network, netName, tags, subNets, errors):
        """Create networks."""
        try:
            netClient = NetworkManagementClient(
                self.authAccount, self.credentials['subscription_id']
            )
            params = {
               'location': self.config['region'],
               'address_space': {
                 'address_prefixes': [network['cidr']]
               }
            }
            if len(tags) > 0:
                params["tags"] = tags

            subFound = False
            netFound = False
            try:
                network = netClient.virtual_networks.get(
                    self.resourceGroup,
                    netName
                )
                if network.provisioning_state == 'Succeeded':
                    netFound = True
                if len(network.subnets) != 0:
                    subFound = True
            except:
                pass

            if not netFound:
                asyncNetCreation = netClient.virtual_networks.create_or_update(
                  self.resourceGroup,
                  netName,
                  params
                )
                asyncNetCreation.wait()
            # This will need to loop if we want more than 1 subnet per network
            if not subFound:
                subNetName = netName + "sub1"
                asyncSubnetCreation = netClient.subnets.create_or_update(
                  self.resourceGroup,
                  netName,
                  subNetName,
                  {'address_prefix': network['subnet']}
                )
                asyncSubnetCreation.wait()
                subNets.put({
                    self.id: asyncSubnetCreation.result()
                })
            else:
                subNets.put({
                    self.id: network.subnets[0]
                })
        except Exception as e:
            print("Error creating network {}".format(str(e)))
            errors.put(Exception(e))

    def nsg(self, vm, tags):
        """Create NSG."""
        netClient = NetworkManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        nsgName = self.id + vm['name'] + "Nsg"
        rules = {
          "location": self.config['region'],
          "security_rules": [
            {
              "description": "SSH Access",
              "protocol": "Tcp",
              "source_port_range": "*",
              "source_address_prefix": "*",
              "destination_address_prefix": "*",
              "destination_port_range": "22",
              "access": "Allow",
              "priority": 100,
              "direction": "Inbound",
              "name": nsgName + "-22-nsg"
            },
            {
              "description": nsgName + "-" + str(vm['service_port']),
              "protocol": "Tcp",
              "source_port_range": "*",
              "source_address_prefix": "*",
              "destination_address_prefix": "*",
              "destination_port_range": str(vm['service_port']),
              "access": "Allow",
              "priority": 110,
              "direction":"Inbound",
              "name": nsgName + "-" + str(vm['service_port']) + "-nsg"
            }
          ]
        }
        if len(tags) > 0:
            rules["tags"] = tags
        nsgCreated = False
        try:
            asyncNsgOp = netClient.network_security_groups.get(
                self.resourceGroup,
                nsgName
            )
            asyncNsgOp.wait()
            nsg = asyncNsgOp.result()
            return nsg
        except Exception:
            pass
        if not nsgCreated:
            aNsgOp = netClient \
                .network_security_groups.create_or_update(
                    self.resourceGroup,
                    nsgName,
                    rules
                )
            aNsgOp.wait()
            nsg = aNsgOp.result()
            return nsg

    def generateNicParams(self, vm, vmName, subnet, pubIP, tags):
        """Generate the Nic Parameters."""
        params = {
            'location': self.config['region'],
          }
        ipConfig = [{
          'name': vmName + '-nic',
          'subnet': {
            'id': subnet.id
          },
          'public_ip_address': {
            'id': pubIP.id
          }
        }]
        if len(tags) > 0:
            params["tags"] = tags

        if 'service_port' in vm:
            nsg = self.nsg(vm, tags)
            params['network_security_group'] = nsg
        if 'beId' in vm:
            ipConfig[0]['load_balancer_backend_address_pools'] = [{
                'id': vm['beId']
            }]

        params['ip_configurations'] = ipConfig
        return params

    def nic(self, vm, vmName, subnet, tags):
        """Create a Network interface for a vm."""
        netClient = NetworkManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        pubIPName = vmName + "pubip"
        pubIpParams = {
          'public_ip_allocation_method': 'Dynamic',
          'location': self.config['region'],
          'public_ip_address_version': 'IPv4',
        }
        if len(tags) > 0:
            pubIpParams['tags'] = tags

        try:
            asycPubIPCreation = netClient.public_ip_addresses.create_or_update(
              self.resourceGroup,
              pubIPName,
              pubIpParams
            )
            asycPubIPCreation.wait()
            pubIP = asycPubIPCreation.result()
            nicParams = self.generateNicParams(vm, vmName, subnet, pubIP, tags)
            asyncNicCreation = netClient.network_interfaces.create_or_update(
              self.resourceGroup,
              vmName + "nic",
              nicParams
            )
        except:
            raise
        details = dict()
        details['public_ip_name'] = pubIPName
        details['nic'] = asyncNicCreation.result()
        return details

    def vmWorker(
                self, opts, vm, vmName, tags, asInfo, subnet, vmQ, errorQ,
                lock, persistData
            ):
        """Worker to create a VM."""
        tmpVm = Vm(opts)
        if 'os' in vm:
            os = vm['os']
        else:
            os = dict()
        if 'image' in vm:
            image = vm['image']
        else:
            image = dict()

        lock.acquire()
        vmNic = self.nic(vm, vmName, subnet, tags)
        lock.release()
        tmpDict = {'type': vm['name']}
        tmpVm.generateParams(
            vmNic['nic'].id,
            vmName,
            asInfo.id,
            {**tags, **tmpDict},
            persistData,
            os,
            image
        )
        tmpVm.create(vmName, vmNic, vmQ, errorQ)
        print("{} VM Created".format(vmName))

    def virtualMachine(
                self, vm, tags, subnet, vmQueue, vmLock, errors,
                persistData=False,
            ):
        """Create a VM."""
        try:
            print("Creating VMs: {}".format(vm['name']))
            vmLock.acquire()
            cmpClient = ComputeManagementClient(
                self.authAccount, self.credentials['subscription_id']
            )
            asName = self.id + '-as' + vm['name']
            try:
                asInfo = cmpClient.availability_sets.create_or_update(
                  self.resourceGroup,
                  asName,
                  {
                    'location': self.config['region'],
                    'tags': tags
                  }
                )
            except Exception as e:
                print("Passing Exception {}".format(e))
                pass
            vmLock.release()
            vmProcList = list()
            opts = dict()
            opts['config'] = self.config
            opts['sa'] = self.storageAccount
            opts['rg'] = self.resourceGroup
            opts['authAccount'] = self.authAccount
            opts['credentials'] = self.credentials
            vmQ = Queue()
            errorQ = Queue()
            lock = Lock()
            results = list()
            i = 1
            if 'existing' in vm:
                i = len(vm['existing']) + 1
            while i <= vm['count']:
                tmpStr = self.id + vm['name'] + str(i)
                vmName = ''.join(e for e in tmpStr if e.isalnum())
                print("Creating {}".format(vmName))
                p = Process(
                    target=self.vmWorker,
                    args=(
                        opts, vm, vmName, tags, asInfo, subnet, vmQ, errorQ,
                        lock, persistData
                    )
                )
                vmProcList.append(p)
                p.start()
                i = i + 1
            for proc in vmProcList:
                # Wait for all VM's to create
                proc.join(400)
                if not errorQ.empty():
                    # If it's not empty there's an error
                    raise Exception({
                        'error': "Error in VmWorker process: {}"
                        .format(errors.get()),
                        'code': 500
                    })
                if vmQ.empty():
                    # There should be items on the queue else it either
                    # Failed or timed-out
                    raise Exception({
                        'error': "Time out creating VM",
                        'code': 500
                    })
                else:
                    results.append(vmQ.get())

            vmQueue.put({'servers': vm['name'], 'vms': results})
        except Exception as e:
            print("Caught exception inside VM {}".format(str(e)))
            errors.put(Exception(e))
            pass

    def lbWorker(self, opts, lb, tags):
        """Worker to create a LB."""
        tmpLb = LoadBalancer(opts, lb, tags)
        result = tmpLb.create()
        return result

    def loadBalancer(self, lb, tags):
        """Create Load Balancer."""
        opts = dict()
        opts['config'] = self.config
        opts['sa'] = self.storageAccount
        opts['rg'] = self.resourceGroup
        opts['authAccount'] = self.authAccount
        opts['credentials'] = self.credentials

        return self.lbWorker(opts, lb, tags)
</code></pre>
  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#platforminfra.infrastructure.azure.Azure">Azure</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, credentials, rg, sa, config=None, id=None)</p>
    </div>
    

    
  
    <div class="desc"><p>The Azure Class.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.__init__', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.__init__" class="source">
    <pre><code>def __init__(self, credentials, rg, sa, config=None, id=None):
    """The Azure Class."""
    # Infrastructure.__init__(self, 'Azure')
    self.setConfig(credentials, config)
    self.resourceGroup = rg
    self.storageAccount = sa
    if id:
        self.setId(id)
    self.apiVersions = {
        'Microsoft.Network/virtualNetworks': '2017-03-01',
        'Microsoft.Compute/availabilitySets': '2017-03-30',
        'Microsoft.Compute/virtualMachines': '2017-03-30',
        'Microsoft.Network/networkInterfaces': '2016-09-01',
        'Microsoft.Network/networkSecurityGroups': '2017-03-01',
        'Microsoft.Network/publicIPAddresses': '2017-03-01',
        'Microsoft.Network/loadBalancers': '2017-03-01'
    }
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.addDNS">
    <p>def <span class="ident">addDNS</span>(</p><p>self, ip, record, domain=&#39;dev.temenos.cloud&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Add DNS Record.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.addDNS', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.addDNS" class="source">
    <pre><code>def addDNS(self, ip, record, domain='dev.temenos.cloud'):
    """Add DNS Record."""
    print("Adding DNS Record")
    dnsClient = DnsManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    try:
        dnsClient.record_sets.create_or_update(
            "mp_dev_core",
            domain,
            record,
            'A',
            {
                "ttl": 300,
                "arecords": [{
                    "ipv4_address": ip
                }]
            }
        )
    except CloudError as e:
        raise Exception(e)
    return record + "." + domain
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.checkResourceExistById">
    <p>def <span class="ident">checkResourceExistById</span>(</p><p>self, type, id)</p>
    </div>
    

    
  
    <div class="desc"><p>Check if a resource Exists by Id.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.checkResourceExistById', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.checkResourceExistById" class="source">
    <pre><code>def checkResourceExistById(self, type, id):
    """Check if a resource Exists by Id."""
    result = False
    try:
        self.getResourceById(type, id)
        result = True
    except:
        pass
    return result
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.createResourceGroup">
    <p>def <span class="ident">createResourceGroup</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Create a RG if not already created.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.createResourceGroup', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.createResourceGroup" class="source">
    <pre><code>def createResourceGroup(self):
    """Create a RG if not already created."""
    resClient = ResourceManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    if not self.resourceGroupAvailable(self.resourceGroup):
        resClient.resource_groups.create_or_update(
          self.resourceGroup,
          {
            'location': self.config['region']
          }
        )
    return self.resourceGroup
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.createStorageAccount">
    <p>def <span class="ident">createStorageAccount</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Create a SA if not already created.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.createStorageAccount', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.createStorageAccount" class="source">
    <pre><code>def createStorageAccount(self):
    """Create a SA if not already created."""
    strClient = StorageManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    if self.storageAccountAvailable():
        saAsyncOp = strClient.storage_accounts.create(
          self.resourceGroup,
          self.storageAccount,
          {
            'sku': {'name': 'standard_lrs'},
            'kind': 'storage',
            'location': self.config['region']
          }
        )
        saAsyncOp.wait()
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.deleteDNSRecord">
    <p>def <span class="ident">deleteDNSRecord</span>(</p><p>self, records, domain=&#39;dev.temenos.cloud&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Delete a record from the domain.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.deleteDNSRecord', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.deleteDNSRecord" class="source">
    <pre><code>def deleteDNSRecord(self, records, domain="dev.temenos.cloud"):
    """Delete a record from the domain."""
    dnsClient = DnsManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    try:
        for record in records:
            dnsClient.record_sets.delete(
                "mp_dev_core",
                domain,
                record,
                'A'
            )
    except CloudError as e:
        raise Exception(e)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.deleteResourceById">
    <p>def <span class="ident">deleteResourceById</span>(</p><p>self, ids)</p>
    </div>
    

    
  
    <div class="desc"><p>Delete a Resource by it's ID.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.deleteResourceById', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.deleteResourceById" class="source">
    <pre><code>def deleteResourceById(self, ids):
    """Delete a Resource by it's ID."""
    resClient = ResourceManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    retry = ids.copy()
    count = 0
    previousIds = list()
    while retry and count < 20:
        for id in retry:
            idSplit = re.split(r"/", id.strip())
            resourceType = idSplit[6] + "/" + idSplit[7]
            try:
                result = resClient.resources.delete_by_id(
                    id,
                    self.apiVersions[resourceType]
                )
                result.wait()
                retry.remove(id)
            except Exception as e:
                if id in previousIds:
                    count = count + 1
                else:
                    previousIds.append(id)
                print("Adding resource to retry list: {}".format(id))
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.deleteStorageAccountContainer">
    <p>def <span class="ident">deleteStorageAccountContainer</span>(</p><p>self, containerName)</p>
    </div>
    

    
  
    <div class="desc"><p>Delete a storage Blob.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.deleteStorageAccountContainer', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.deleteStorageAccountContainer" class="source">
    <pre><code>def deleteStorageAccountContainer(self, containerName):
    """Delete a storage Blob."""
    blockBlobService = BlockBlobService(
        account_name=self.storageAccount,
        account_key=self.getStorageAccountKey()
    )
    found = False
    containers = blockBlobService.list_containers()
    for container in containers:
        if containerName == container.name:
            found = True
    if found:
        deleting = True
        retries = 0
        while deleting and retries < 10:
            try:
                blockBlobService.delete_container(containerName)
                deleting = False
            except:
                time.sleep(10)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.deleteStorageAccountDisk">
    <p>def <span class="ident">deleteStorageAccountDisk</span>(</p><p>self, containerName, disks)</p>
    </div>
    

    
  
    <div class="desc"><p>Delete a storage Blob.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.deleteStorageAccountDisk', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.deleteStorageAccountDisk" class="source">
    <pre><code>def deleteStorageAccountDisk(self, containerName, disks):
    """Delete a storage Blob."""
    blockBlobService = BlockBlobService(
        account_name=self.storageAccount,
        account_key=self.getStorageAccountKey()
    )
    found = False
    containers = blockBlobService.list_containers()
    for container in containers:
        if containerName == container.name:
            found = True
    if found:
        try:
            for disk in disks:
                blockBlobService.delete_blob(
                    containerName,
                    disk
                )
        except Exception as e:
            raise Exception(e)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.generateNicParams">
    <p>def <span class="ident">generateNicParams</span>(</p><p>self, vm, vmName, subnet, pubIP, tags)</p>
    </div>
    

    
  
    <div class="desc"><p>Generate the Nic Parameters.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.generateNicParams', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.generateNicParams" class="source">
    <pre><code>def generateNicParams(self, vm, vmName, subnet, pubIP, tags):
    """Generate the Nic Parameters."""
    params = {
        'location': self.config['region'],
      }
    ipConfig = [{
      'name': vmName + '-nic',
      'subnet': {
        'id': subnet.id
      },
      'public_ip_address': {
        'id': pubIP.id
      }
    }]
    if len(tags) > 0:
        params["tags"] = tags
    if 'service_port' in vm:
        nsg = self.nsg(vm, tags)
        params['network_security_group'] = nsg
    if 'beId' in vm:
        ipConfig[0]['load_balancer_backend_address_pools'] = [{
            'id': vm['beId']
        }]
    params['ip_configurations'] = ipConfig
    return params
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.getDNSRecords">
    <p>def <span class="ident">getDNSRecords</span>(</p><p>self, id, domain=&#39;dev.temenos.cloud&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Get DNS Records by ID.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.getDNSRecords', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.getDNSRecords" class="source">
    <pre><code>def getDNSRecords(self, id, domain="dev.temenos.cloud"):
    """Get DNS Records by ID."""
    dnsClient = DnsManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    records = dnsClient.record_sets.list_by_type(
        "mp_dev_core",
        domain,
        'A'
    )
    results = list()
    for record in records:
        if id == re.split(r"-", record.name.strip())[-1]:
            results.append(record.name)
    return results
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.getResourceById">
    <p>def <span class="ident">getResourceById</span>(</p><p>self, type, id)</p>
    </div>
    

    
  
    <div class="desc"><p>Get a resource by ID.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.getResourceById', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.getResourceById" class="source">
    <pre><code>def getResourceById(self, type, id):
    """Get a resource by ID."""
    resClient = ResourceManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    result = resClient.resources.get_by_id(
        id,
        self.apiVersions[type]
    )
    return result
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.getResources">
    <p>def <span class="ident">getResources</span>(</p><p>self, id=None, filter=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Get all resources.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.getResources', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.getResources" class="source">
    <pre><code>def getResources(self, id=None, filter=None):
    """Get all resources."""
    resClient = ResourceManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    filterStr = str()
    if id:
        filterStr = "tagname eq 'uuid' and tagvalue eq '{}'".format(id)
        if filter:
            filterStr = " tagname eq '{key}' and tagvalue eq '{value}'"\
                .format(**filter)
        resourceList = resClient.resources.list(
            filter=filterStr
        )
        resources = dict()
        ids = list()
        try:
            for page in resourceList.next():
                if filter:
                    if id in page.id:
                        ids.append(page.id)
                else:
                    ids.append(page.id)
            if ids:
                resources["ids"] = ids
            dnsEntries = self.getDNSRecords(id)
            if dnsEntries:
                resources["dns"] = dnsEntries
            disks = self.getStorageDisks(id, filter)
            if disks:
                resources["vhds"] = disks
        except CloudError as e:
            # TODO: Decide to raiseor not, not frequently happening.
            print("Error: {}".format(e))
            pass
        return resources
    else:
        filterStr = "tagname eq 'uuid'"
        resourceList = resClient.resource_groups.list_resources(
            self.resourceGroup,
            filter=filterStr
        )
        ids = set()
        try:
            for page in resourceList.next():
                resource = self.getResourceById(page.type, page.id)
                ids.add(resource.tags['uuid'])
        except CloudError as e:
            # TODO: Decide to raise or not, Not frequently happening
            print("Error: {}".format(e))
            pass
        return list(ids)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.getStorageAccountKey">
    <p>def <span class="ident">getStorageAccountKey</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a Storage account Key.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.getStorageAccountKey', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.getStorageAccountKey" class="source">
    <pre><code>def getStorageAccountKey(self):
    """Return a Storage account Key."""
    strClient = StorageManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    saKeys = strClient.storage_accounts.list_keys(
        self.resourceGroup,
        self.storageAccount
    )
    return saKeys.keys[0].value
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.getStorageDisks">
    <p>def <span class="ident">getStorageDisks</span>(</p><p>self, id, filter)</p>
    </div>
    

    
  
    <div class="desc"><p>Get a list of Storage disks.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.getStorageDisks', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.getStorageDisks" class="source">
    <pre><code>def getStorageDisks(self, id, filter):
    """Get a list of Storage disks."""
    saKey = self.getStorageAccountKey()
    disks = list()
    blockBlobService = BlockBlobService(
        account_name=self.storageAccount,
        account_key=saKey
    )
    found = False
    containers = blockBlobService.list_containers()
    for container in containers:
        if id == container.name:
            found = True
    if found:
        blobs = blockBlobService.list_blobs(id)
        for blob in blobs:
            if filter:
                search = ''.join(e for e in filter['value'] if e.isalnum())
                if search in blob.name:
                    disks.append(blob.name)
            else:
                disks.append(blob.name)
    return disks
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.getSubnetID">
    <p>def <span class="ident">getSubnetID</span>(</p><p>self, netName)</p>
    </div>
    

    
  
    <div class="desc"><p>Get the Subnets for a network.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.getSubnetID', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.getSubnetID" class="source">
    <pre><code>def getSubnetID(self, netName):
    """Get the Subnets for a network."""
    netClient = NetworkManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    subFound = False
    netFound = False
    try:
        network = netClient.virtual_networks.get(
            self.resourceGroup,
            netName
        )
        if network.provisioning_state == 'Succeeded':
            netFound = True
        if len(network.subnets) != 0:
            subFound = True
    except:
        pass
    if not netFound:
        return {'error': "No network of name: {}".format(netName)}
    if not subFound:
        return {'error': "No Subnets foing in network: {}".format(netName)}
    return network.subnets[0]
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.getVmInfo">
    <p>def <span class="ident">getVmInfo</span>(</p><p>self, vmName, id, rg)</p>
    </div>
    

    
  
    <div class="desc"><p>Get Extended info about a VM.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.getVmInfo', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.getVmInfo" class="source">
    <pre><code>def getVmInfo(self, vmName, id, rg):
    """Get Extended info about a VM."""
    cmpClient = ComputeManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    result = cmpClient.virtual_machines.get(rg, vmName, "instanceView")
    return result
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.lbWorker">
    <p>def <span class="ident">lbWorker</span>(</p><p>self, opts, lb, tags)</p>
    </div>
    

    
  
    <div class="desc"><p>Worker to create a LB.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.lbWorker', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.lbWorker" class="source">
    <pre><code>def lbWorker(self, opts, lb, tags):
    """Worker to create a LB."""
    tmpLb = LoadBalancer(opts, lb, tags)
    result = tmpLb.create()
    return result
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.loadBalancer">
    <p>def <span class="ident">loadBalancer</span>(</p><p>self, lb, tags)</p>
    </div>
    

    
  
    <div class="desc"><p>Create Load Balancer.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.loadBalancer', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.loadBalancer" class="source">
    <pre><code>def loadBalancer(self, lb, tags):
    """Create Load Balancer."""
    opts = dict()
    opts['config'] = self.config
    opts['sa'] = self.storageAccount
    opts['rg'] = self.resourceGroup
    opts['authAccount'] = self.authAccount
    opts['credentials'] = self.credentials
    return self.lbWorker(opts, lb, tags)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.network">
    <p>def <span class="ident">network</span>(</p><p>self, network, netName, tags, subNets, errors)</p>
    </div>
    

    
  
    <div class="desc"><p>Create networks.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.network', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.network" class="source">
    <pre><code>def network(self, network, netName, tags, subNets, errors):
    """Create networks."""
    try:
        netClient = NetworkManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        params = {
           'location': self.config['region'],
           'address_space': {
             'address_prefixes': [network['cidr']]
           }
        }
        if len(tags) > 0:
            params["tags"] = tags
        subFound = False
        netFound = False
        try:
            network = netClient.virtual_networks.get(
                self.resourceGroup,
                netName
            )
            if network.provisioning_state == 'Succeeded':
                netFound = True
            if len(network.subnets) != 0:
                subFound = True
        except:
            pass
        if not netFound:
            asyncNetCreation = netClient.virtual_networks.create_or_update(
              self.resourceGroup,
              netName,
              params
            )
            asyncNetCreation.wait()
        # This will need to loop if we want more than 1 subnet per network
        if not subFound:
            subNetName = netName + "sub1"
            asyncSubnetCreation = netClient.subnets.create_or_update(
              self.resourceGroup,
              netName,
              subNetName,
              {'address_prefix': network['subnet']}
            )
            asyncSubnetCreation.wait()
            subNets.put({
                self.id: asyncSubnetCreation.result()
            })
        else:
            subNets.put({
                self.id: network.subnets[0]
            })
    except Exception as e:
        print("Error creating network {}".format(str(e)))
        errors.put(Exception(e))
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.nic">
    <p>def <span class="ident">nic</span>(</p><p>self, vm, vmName, subnet, tags)</p>
    </div>
    

    
  
    <div class="desc"><p>Create a Network interface for a vm.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.nic', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.nic" class="source">
    <pre><code>def nic(self, vm, vmName, subnet, tags):
    """Create a Network interface for a vm."""
    netClient = NetworkManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    pubIPName = vmName + "pubip"
    pubIpParams = {
      'public_ip_allocation_method': 'Dynamic',
      'location': self.config['region'],
      'public_ip_address_version': 'IPv4',
    }
    if len(tags) > 0:
        pubIpParams['tags'] = tags
    try:
        asycPubIPCreation = netClient.public_ip_addresses.create_or_update(
          self.resourceGroup,
          pubIPName,
          pubIpParams
        )
        asycPubIPCreation.wait()
        pubIP = asycPubIPCreation.result()
        nicParams = self.generateNicParams(vm, vmName, subnet, pubIP, tags)
        asyncNicCreation = netClient.network_interfaces.create_or_update(
          self.resourceGroup,
          vmName + "nic",
          nicParams
        )
    except:
        raise
    details = dict()
    details['public_ip_name'] = pubIPName
    details['nic'] = asyncNicCreation.result()
    return details
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.nsg">
    <p>def <span class="ident">nsg</span>(</p><p>self, vm, tags)</p>
    </div>
    

    
  
    <div class="desc"><p>Create NSG.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.nsg', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.nsg" class="source">
    <pre><code>def nsg(self, vm, tags):
    """Create NSG."""
    netClient = NetworkManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    nsgName = self.id + vm['name'] + "Nsg"
    rules = {
      "location": self.config['region'],
      "security_rules": [
        {
          "description": "SSH Access",
          "protocol": "Tcp",
          "source_port_range": "*",
          "source_address_prefix": "*",
          "destination_address_prefix": "*",
          "destination_port_range": "22",
          "access": "Allow",
          "priority": 100,
          "direction": "Inbound",
          "name": nsgName + "-22-nsg"
        },
        {
          "description": nsgName + "-" + str(vm['service_port']),
          "protocol": "Tcp",
          "source_port_range": "*",
          "source_address_prefix": "*",
          "destination_address_prefix": "*",
          "destination_port_range": str(vm['service_port']),
          "access": "Allow",
          "priority": 110,
          "direction":"Inbound",
          "name": nsgName + "-" + str(vm['service_port']) + "-nsg"
        }
      ]
    }
    if len(tags) > 0:
        rules["tags"] = tags
    nsgCreated = False
    try:
        asyncNsgOp = netClient.network_security_groups.get(
            self.resourceGroup,
            nsgName
        )
        asyncNsgOp.wait()
        nsg = asyncNsgOp.result()
        return nsg
    except Exception:
        pass
    if not nsgCreated:
        aNsgOp = netClient \
            .network_security_groups.create_or_update(
                self.resourceGroup,
                nsgName,
                rules
            )
        aNsgOp.wait()
        nsg = aNsgOp.result()
        return nsg
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.resourceGroupAvailable">
    <p>def <span class="ident">resourceGroupAvailable</span>(</p><p>self, rg)</p>
    </div>
    

    
  
    <div class="desc"><p>Test to See if TG is available.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.resourceGroupAvailable', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.resourceGroupAvailable" class="source">
    <pre><code>def resourceGroupAvailable(self, rg):
    """Test to See if TG is available."""
    resClient = ResourceManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    result = resClient.resource_groups.check_existence(rg)
    return result
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.setConfig">
    <p>def <span class="ident">setConfig</span>(</p><p>self, credentials, config)</p>
    </div>
    

    
  
    <div class="desc"><p>Set the config.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.setConfig', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.setConfig" class="source">
    <pre><code>def setConfig(self, credentials, config):
    """Set the config."""
    if config:
        self.credentials = getCredentials(config)
        self.config = getConfig(config['provider'])
        self.resources = getResources(config['services'])
    else:
        self.credentials = getCredentials(credentials)
    self.authAccount = ServicePrincipalCredentials(
        client_id=self.credentials['client_id'],
        secret=self.credentials['secret'],
        tenant=self.credentials['tenant']
    )
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.setId">
    <p>def <span class="ident">setId</span>(</p><p>self, id)</p>
    </div>
    

    
  
    <div class="desc"><p>Set the Id.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.setId', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.setId" class="source">
    <pre><code>def setId(self, id):
    """Set the Id."""
    self.id = id
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.startVm">
    <p>def <span class="ident">startVm</span>(</p><p>self, vmName, rg)</p>
    </div>
    

    
  
    <div class="desc"><p>Sart a VM.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.startVm', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.startVm" class="source">
    <pre><code>def startVm(self, vmName, rg):
    """Sart a VM."""
    cmpClient = ComputeManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    result = cmpClient.virtual_machines.start(rg, vmName)
    return result
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.stopVm">
    <p>def <span class="ident">stopVm</span>(</p><p>self, vmName, rg)</p>
    </div>
    

    
  
    <div class="desc"><p>Stop a VM.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.stopVm', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.stopVm" class="source">
    <pre><code>def stopVm(self, vmName, rg):
    """Stop a VM."""
    cmpClient = ComputeManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    result = cmpClient.virtual_machines.power_off(rg, vmName)
    return result
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.storageAccountAvailable">
    <p>def <span class="ident">storageAccountAvailable</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Test to see if a SA is available.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.storageAccountAvailable', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.storageAccountAvailable" class="source">
    <pre><code>def storageAccountAvailable(self):
    """Test to see if a SA is available."""
    strClient = StorageManagementClient(
        self.authAccount, self.credentials['subscription_id']
    )
    availability = strClient.storage_accounts.check_name_availability(
        self.storageAccount
    )
    return availability.name_available
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.virtualMachine">
    <p>def <span class="ident">virtualMachine</span>(</p><p>self, vm, tags, subnet, vmQueue, vmLock, errors, persistData=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Create a VM.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.virtualMachine', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.virtualMachine" class="source">
    <pre><code>def virtualMachine(
            self, vm, tags, subnet, vmQueue, vmLock, errors,
            persistData=False,
        ):
    """Create a VM."""
    try:
        print("Creating VMs: {}".format(vm['name']))
        vmLock.acquire()
        cmpClient = ComputeManagementClient(
            self.authAccount, self.credentials['subscription_id']
        )
        asName = self.id + '-as' + vm['name']
        try:
            asInfo = cmpClient.availability_sets.create_or_update(
              self.resourceGroup,
              asName,
              {
                'location': self.config['region'],
                'tags': tags
              }
            )
        except Exception as e:
            print("Passing Exception {}".format(e))
            pass
        vmLock.release()
        vmProcList = list()
        opts = dict()
        opts['config'] = self.config
        opts['sa'] = self.storageAccount
        opts['rg'] = self.resourceGroup
        opts['authAccount'] = self.authAccount
        opts['credentials'] = self.credentials
        vmQ = Queue()
        errorQ = Queue()
        lock = Lock()
        results = list()
        i = 1
        if 'existing' in vm:
            i = len(vm['existing']) + 1
        while i <= vm['count']:
            tmpStr = self.id + vm['name'] + str(i)
            vmName = ''.join(e for e in tmpStr if e.isalnum())
            print("Creating {}".format(vmName))
            p = Process(
                target=self.vmWorker,
                args=(
                    opts, vm, vmName, tags, asInfo, subnet, vmQ, errorQ,
                    lock, persistData
                )
            )
            vmProcList.append(p)
            p.start()
            i = i + 1
        for proc in vmProcList:
            # Wait for all VM's to create
            proc.join(400)
            if not errorQ.empty():
                # If it's not empty there's an error
                raise Exception({
                    'error': "Error in VmWorker process: {}"
                    .format(errors.get()),
                    'code': 500
                })
            if vmQ.empty():
                # There should be items on the queue else it either
                # Failed or timed-out
                raise Exception({
                    'error': "Time out creating VM",
                    'code': 500
                })
            else:
                results.append(vmQ.get())
        vmQueue.put({'servers': vm['name'], 'vms': results})
    except Exception as e:
        print("Caught exception inside VM {}".format(str(e)))
        errors.put(Exception(e))
        pass
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.infrastructure.azure.Azure.vmWorker">
    <p>def <span class="ident">vmWorker</span>(</p><p>self, opts, vm, vmName, tags, asInfo, subnet, vmQ, errorQ, lock, persistData)</p>
    </div>
    

    
  
    <div class="desc"><p>Worker to create a VM.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.infrastructure.azure.Azure.vmWorker', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.infrastructure.azure.Azure.vmWorker" class="source">
    <pre><code>def vmWorker(
            self, opts, vm, vmName, tags, asInfo, subnet, vmQ, errorQ,
            lock, persistData
        ):
    """Worker to create a VM."""
    tmpVm = Vm(opts)
    if 'os' in vm:
        os = vm['os']
    else:
        os = dict()
    if 'image' in vm:
        image = vm['image']
    else:
        image = dict()
    lock.acquire()
    vmNic = self.nic(vm, vmName, subnet, tags)
    lock.release()
    tmpDict = {'type': vm['name']}
    tmpVm.generateParams(
        vmNic['nic'].id,
        vmName,
        asInfo.id,
        {**tags, **tmpDict},
        persistData,
        os,
        image
    )
    tmpVm.create(vmName, vmNic, vmQ, errorQ)
    print("{} VM Created".format(vmName))
</code></pre>
  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="platforminfra.infrastructure.azure.Azure.apiVersions" class="name">var <span class="ident">apiVersions</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="platforminfra.infrastructure.azure.Azure.resourceGroup" class="name">var <span class="ident">resourceGroup</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="platforminfra.infrastructure.azure.Azure.storageAccount" class="name">var <span class="ident">storageAccount</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

    <h2 class="section-title" id="header-submodules">Sub-modules</h2>
      <div class="item">
      <p class="name"><a href="dependencies/index.html">platforminfra.infrastructure.azure.dependencies</a></p>
      
  
    <div class="desc"><p>Order a template by dependencies.</p>
<p>Take an unordered list of resources from a template and put them into an
ordered list of resources.</p></div>

      </div>
      <div class="item">
      <p class="name"><a href="loadBalancer/index.html">platforminfra.infrastructure.azure.loadBalancer</a></p>
      
  
    <div class="desc"><p>Module for managing Load Balancers.</p></div>

      </div>
      <div class="item">
      <p class="name"><a href="vm/index.html">platforminfra.infrastructure.azure.vm</a></p>
      
  
    <div class="desc"><p>Module for managing VM's.</p></div>

      </div>
  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
