<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>platforminfra.controller API documentation</title>
    <meta name="description" content="PlatformInfra Controller.

The controller orchestrates the main actions of the platform.
This includ..." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>


  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">


    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#platforminfra.controller.Controller">Controller</a></span>
        
          
  <ul>
    <li class="mono"><a href="#platforminfra.controller.Controller.__init__">__init__</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.addVM">addVM</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.checkJenkinsRunning">checkJenkinsRunning</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.checkUUIDInUse">checkUUIDInUse</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.checkVMResources">checkVMResources</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.compareResources">compareResources</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.createEnvironment">createEnvironment</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.createLoadBalancer">createLoadBalancer</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.createLoadBalancers">createLoadBalancers</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.createNetworks">createNetworks</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.createVms">createVms</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.deleteEnvironment">deleteEnvironment</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.environmentServerStopStart">environmentServerStopStart</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.environmentStatus">environmentStatus</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.getJenkinsBuildStatus">getJenkinsBuildStatus</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.getResourceDetails">getResourceDetails</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.getStatusById">getStatusById</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.getTemplate">getTemplate</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.getVMBEID">getVMBEID</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.getVMDetails">getVMDetails</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.getVmList">getVmList</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.listEnvironments">listEnvironments</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.rebuildEnvironmentServer">rebuildEnvironmentServer</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.runGitlabTasks">runGitlabTasks</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.runJenkinsPipeline">runJenkinsPipeline</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.scaleEnvironmentServer">scaleEnvironmentServer</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.setTags">setTags</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.startVM">startVM</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.stopVM">stopVM</a></li>
    <li class="mono"><a href="#platforminfra.controller.Controller.validateLoadBalancer">validateLoadBalancer</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">platforminfra.controller</span> module</h1>
  <p>PlatformInfra Controller.</p>
<p>The controller orchestrates the main actions of the platform.
This includes calling the underlying provider methods and the simpler
additional actions such as Jenkins and gitlab.</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller" class="source">
    <pre><code>"""PlatformInfra Controller.

The controller orchestrates the main actions of the platform.
This includes calling the underlying provider methods and the simpler
additional actions such as Jenkins and gitlab.

"""

from platforminfra.templates import Template
from platforminfra.config import Config
from platforminfra.infrastructure.azure import Azure
from multiprocessing import Process, Queue, Lock
from copy import deepcopy

from ..helpers import Jenkins, Gitlab, Helpers
import re


class Controller(object):
    """Controls the platformInfra.

    The controller Object carries out all of the actions.
    As this expands it will be neccessary to move the control of the
    infrastructure into its own module. For now the boundaries between Control
    and provider are blurred. The provider works on the resource and sometimes
    *with* the resource whereas the controller only works *with* the resource.
    """

    def __init__(self):
        """Initialise the controller."""
        self.templates = Template(templateDir='./templates/')
        self.tags = dict()
        self.subnets = list()
        self.vms = list()
        self.lbs = list()
        self.config = Config()

    def getTemplate(self, templateName):
        """Get a Template by Name."""
        return self.templates.loadTemplate(templateName)

    def setTags(self, data):
        """Create the tags property."""
        print("Creating Tags")
        self.tags = {**self.tags, **data}

    def checkUUIDInUse(self, uuid):
        """Given a UUID validate if it is in use or not."""
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name']
        )

        uuids = provider.getResources()
        if uuid in uuids:
            return True
        else:
            return False

    def getResourceDetails(self, id):
        """Get a VM object back from an ID."""
        resource = dict()
        resource['id'] = id
        idSplit = re.split(r"/", id.strip())
        resource['name'] = idSplit[-1]
        resource['type'] = idSplit[6] + "/" + idSplit[7]
        resource['group'] = idSplit[4]

        return resource

    def getVmList(self, provider, uuid, server):
        """Return a list of VM's and their current running state."""
        resources = provider.getResources(id=uuid, filter={
            'key': 'type',
            'value': server
        })
        if 'ids' in resources:
            statuses = self.getStatusById(resources['ids'], provider)
            return statuses
        else:
            raise Exception({
                'error': "No VM Resources found for {} in {}".format(
                    server,
                    uuid
                ),
                'code': 404
            })

    def getVMDetails(self, id, server):
        """Get a VM object back from an ID."""
        vm = dict()
        vm['id'] = id
        idSplit = re.split(r"/", id.strip())
        vm['name'] = idSplit[-1]
        vm['type'] = idSplit[6] + "/" + idSplit[7]
        vm['server'] = server
        countSplit = re.split(r"{}".format(type), vm['name'].strip())
        vm['position'] = countSplit[-1]

        return vm

    def getVMBEID(
            self, provider, id=None, template=None,
            server=None, uuid=None
            ):
        """For an ID get the BE ID."""
        beId = None
        if template and uuid and server:
            if 'load_balancers' in template['services']:
                for lb in template['services']['load_balancers']:
                    if lb['be_servers'] == server:
                        lbName = lb['name']
                        resources = provider.getResources(id=uuid)
                        for id in resources['ids']:
                            idSplit = re.split(r"/", id.strip())
                            resourceType = idSplit[6] + "/" + idSplit[7]
                            resourceName = idSplit[-1]
                            lbResName = 'Microsoft.Network/loadBalancers'
                            if resourceType == lbResName and \
                                    lbName in resourceName:
                                print("Getting LB")
                                # Found the Id of the Load balancer
                                # for the server
                                lb = provider.getResourceById(resourceType, id)
                                be = lb.properties['backendAddressPools'][0]
                                beId = be['id']
        return beId

    def runJenkinsPipeline(self, pipeline):
        """Run a specified Jenkins pipeline."""
        jenkinsServer = Jenkins(
            self.config.credentials['jenkins']['url'],
            user=self.config.credentials['jenkins']['user'],
            password=self.config.credentials['jenkins']['password']
        )
        print("Running Jenkins Job")
        jenkinsServer.runBuildWithParams(
            pipeline,
            params={
                "UUID": self.tags['uuid']
            }
        )

    def getJenkinsBuildStatus(self, pipeline, uuid):
        """Get a pipeline status for a given uuid."""
        jenkinsServer = Jenkins(
            self.config.credentials['jenkins']['url'],
            user=self.config.credentials['jenkins']['user'],
            password=self.config.credentials['jenkins']['password']
        )
        status = jenkinsServer.getBuildStatus(
            pipeline,
            uuid
        )
        return status

    def checkJenkinsRunning(self, pipeline, uuid):
        """Check a list of responses and return boolean."""
        statuses = self.getJenkinsBuildStatus(pipeline, uuid)
        running = False
        for status in statuses:
            if status['status'] == 'RUNNING':
                running = True
        return running

    def runGitlabTasks(self, gitlab, app):
        """Run the required actrions for Gitlab creation."""
        response = dict()
        print("Connecting to Gitlab")
        glServerConn = self.config.credentials['gitlab']['url']
        glServerToken = self.config.credentials['gitlab']['token']
        glSourceTeam = "root"
        glServer = Gitlab(glServerConn, glServerToken)

        print("Create user")
        password = Helpers.randStr(10)
        if 'password' in gitlab['user']:
            password = gitlab['user']['password']
        user = glServer.createUser(
            self.tags['uuid'],
            self.tags['uuid'],
            password,
            self.tags['uuid'] + '@example.net'
        )
        print("Adding SSH key for User")
        if 'sshKey' in gitlab['user']:
            key = glServer.addSshKey(user, gitlab['user']['sshKey'])
            if type(key) is dict:
                if 'error' in key:
                    raise Exception(key)
        response['user'] = user.username
        print("Cloning Repos")
        if 'cloneRepos' in gitlab:
            response['repos'] = dict()
            for repo in gitlab['cloneRepos']:
                glSourceProject = glServer.getProject(glSourceTeam, repo)
                if type(glSourceProject) is dict:
                    if 'error' in glSourceProject:
                        raise Exception(glSourceProject)
                forked = glServer.forkProject(
                    user.username,
                    glSourceProject.id
                )
                if type(forked) is dict:
                    if 'error' in forked:
                        raise Exception(forked)
                print("Getting the SSH url for the repo")
                response['repos'][repo] = {
                    'ssh': forked.ssh_url_to_repo,
                    'web': forked.http_url_to_repo
                }
                print("Granting access to forked repo")
                member = glServer.addUserToProjectMembers(user, forked)
                if type(member) is dict:
                    if 'error' in member:
                        raise Exception(member)
                print("Hooking it up")
                hook = glServer.addHook(
                    self.config.credentials['jenkins']['url'] +
                    "/project/{}/".format(app),
                    forked
                )
                if type(hook) is dict:
                    if 'error' in hook:
                        raise Exception(hook)

        return response

    def addVM(
            self, vms, provider, template, uuid, application=None,
            count=None, persistData=False
            ):
        """Given an Existing list of VMs Add more."""
        if not count:
            for server in template['services']['servers']:
                if server['name'] == vms[0]['server']:
                    count = server['count']
        vm = dict()
        vm['count'] = count
        print("Getting BE ID")
        beId = self.getVMBEID(
            provider,
            template=template,
            server=vms[0]['server'],
            uuid=uuid
        )
        if 'id' in vms[0]:
            existingIds = list()
            for item in vms:
                if provider.checkResourceExistById(
                    'Microsoft.Compute/virtualMachines',
                    item['id']
                ):
                    existingIds.append(item['id'])
            vm['existing'] = existingIds
        if beId:
            vm['beId'] = beId
        vm['name'] = vms[0]['server']
        vmList = [vm]
        # There's only a single subnet per network
        netName = template['services']['networks'][0]['name']
        subnet = provider.getSubnetID(uuid + netName + "0")
        self.tags['uuid'] = uuid
        self.subnets.append({'subnets': {uuid: subnet}})
        self.createVms(vmList, provider, persistData)

        if 'application':
            self.runJenkinsPipeline(application)

    def getStatusById(self, ids, provider):
        """Get the status of a resource."""
        statuses = list()
        for id in ids:
            details = self.getResourceDetails(id)
            item = provider.getResourceById(details['type'], details['id'])
            if 'provisioningState' in item.properties:
                tmpItem = {
                    'name': details['name'],
                    'type': details['type'],
                    'resourceGroup': details['group'],
                    'provisioningState': item.properties['provisioningState']
                }
                if item.type == "Microsoft.Compute/virtualMachines":
                    vmData = provider.getVmInfo(
                        item.name,
                        item.id,
                        details['group']
                    )
                    for status in vmData.instance_view.statuses:
                        if 'PowerState' in status.code:
                            tmpItem['status'] = status.display_status
                    disks = list()
                    for disk in vmData.instance_view.disks:
                        for status in disk.statuses:
                            disks.append({
                                "name": disk.name,
                                "provisioningState": status.display_status
                            })
                    tmpItem['disks'] = disks
            else:
                if details['type'] == 'Microsoft.Compute/availabilitySets':
                    tmpItem = {
                        'name': details['name'],
                        'type': details['type'],
                        'resourceGroup': details['group'],
                        'provisioningState': 'Succeeded'
                    }
                else:
                    tmpItem = {
                        'name': details['name'],
                        'type': details['type'],
                        'resourceGroup': details['group'],
                        'provisioningState': 'Unknown'
                    }
            statuses.append(tmpItem)
        return statuses

    def checkVMResources(self, vmName, resources):
        """Given a VM Name does it have the right resources."""
        vm = dict()
        vm['vm'] = False
        vm['nic'] = False
        vm['pip'] = False
        vm['disks'] = False
        vm['name'] = vmName
        for resource in resources:
            if resource['type'] == "Microsoft.Compute/virtualMachines"\
                    and vmName in resource['name']:
                    if resource['provisioningState'] == 'Succeeded':
                        vm['vm'] = True
                    disks = list()
                    for disk in resource['disks']:
                        if 'succeeded' in disk['provisioningState']:
                            disks.append(True)
                        else:
                            disks.append(False)
                    if all(disks):
                        vm['disks'] = True

            if resource['type'] == "Microsoft.Network/networkInterfaces"\
                    and vmName in resource['name']:
                    vm['nic'] = True
            if resource['type'] == "Microsoft.Network/publicIPAddresses"\
                    and vmName in resource['name']:
                    vm['pip'] = True
        return vm

    def compareResources(self, statusRes, deploymentRes, uuid):
        """Compare a status list with the Deployment resources.

        Loop through the expected resources (deploymnetRes) and ensure at least
        one of each is found in the statusRes so we inform the request if all
        resources are 'okay' or not.
        """
        deployNetworkCount = list()
        for resource in deploymentRes['resources']:
            if 'networks' in resource:
                for network in resource['networks']:
                    deployNetworkCount.append(network['name'])
        statusNetworkCount = list()
        statusVmCount = list()
        for i in statusRes:
            if "Environment resources" in i:
                for resource in i["Environment resources"]:
                    if resource['type'] == "Microsoft.Network/virtualNetworks":
                        statusNetworkCount.append(resource['name'])
                    if resource['type'] == "Microsoft.Compute/virtualMachines":
                        statusVmCount.append(self.checkVMResources(
                                resource['name'],
                                i["Environment resources"]
                            )
                        )
        # Create a list of all of the broken resources so they can be eaisly
        # displayed within the status response.
        brokenResources = list()
        for vm in statusVmCount:
            # If a VM Does not have these it is not 'good'
            if not (vm['vm'] and vm['nic'] and vm['pip'] and vm['disks']):
                print("VM {} is broken".format(vm['name']))
                brokenResources.append({
                    'name': vm['name'],
                    'type': "Microsoft.Compute/virtualMachines",
                    'status': "Failed"
                })

        for network in deployNetworkCount:
            for statusNetwork in statusNetworkCount:
                if network not in statusNetwork:
                    brokenResources.append({
                        'name': network,
                        'type': "Microsoft.Network/virtualNetworks",
                        'status': "Failed"
                    })

        return brokenResources

    def createNetworks(self, data, provider):
        """Create Networks."""
        # Must complete before everything else is built
        subNets = Queue()
        errors = Queue()
        print("Creating network")
        netProcs = list()
        try:
            for idx, network in enumerate(data):
                netId = str(self.tags['uuid'])+network['name']+str(idx)
                p = Process(
                    target=provider.network,
                    args=(network, netId, self.tags, subNets, errors)
                )
                netProcs.append(p)
                p.start()

            subnets = dict()
            for proc in netProcs:
                try:
                    proc.join(600)
                except:
                    proc.terminate()
                    raise
                if not errors.empty():
                    # If it's not empty there's an error
                    raise Exception({
                        'error': "Error in child process for networking: {}"
                        .format(errors.get()),
                        'code': 500
                    })
                if subNets.empty():
                    raise Exception({
                        'error': "Time out creating network",
                        'code': 500
                    })
                else:
                    subnets['subnets'] = subNets.get()
        except Exception as e:
            if e.args[0] is dict:
                raise Exception(e)
            else:
                raise Exception({
                    'error': "Unknown error while creating networks: {}"
                    .format(str(e))
                })

        self.subnets.append(subnets)

    def stopVM(self, provider, vm):
        """Stop a running VM."""
        provider.stopVm(vm['name'], vm['resourceGroup'])

    def startVM(self, provider, vm):
        """Start a stopped VM."""
        provider.startVm(vm['name'], vm['resourceGroup'])

    def createVms(self, data, provider, persistData=False):
        """Create VMs.

        For a given set of data, for each 'server' group create each server
        with all of dependencies each VM needs.
        """
        print("Creating Servers")
        vms = Queue()
        errors = Queue()
        vmLock = Lock()
        # Processes that can be run in parrallel
        serverProcs = list()
        try:
            for i in self.subnets:
                if self.tags['uuid'] in i['subnets']:
                    # Grab A subnet - needs reworking when multiple networks is
                    # supported
                    vmSubnet = i['subnets'][self.tags['uuid']]
            for server in data:
                # For each 'server' Spawn a process to create that vm
                p = Process(
                    target=provider.virtualMachine,
                    args=(
                        server,
                        self.tags,
                        vmSubnet,
                        vms,
                        vmLock,
                        errors,
                        persistData
                    )
                )
                vmDetails = {
                    'servers': server['name'],
                    'process': p
                }
                if 'dns' in server:
                    vmDetails['dns'] = server['dns']
                serverProcs.append(vmDetails)
                p.start()

            for proc in serverProcs:
                try:
                    proc['process'].join(600)
                except:
                    proc['process'].terminate()
                    raise
                if not errors.empty():
                    # If it's not empty there's an error
                    print("Errors not empty")
                    raise Exception({
                        'error': "Error in child process for VM: {}"
                        .format(errors.get()),
                        'code': 500
                    })
                if vms.empty():
                    print("vms empty")
                    raise Exception({
                        'error': "Time out creating VMs",
                        'code': 500
                    })
                else:
                    tmpData = vms.get()
                    if 'dns' in proc:
                        # Only apply to the first server
                        result = provider.addDNS(
                            tmpData['vms'][0]['public_ip'],
                            proc['dns'] + '-' + self.tags['uuid']
                        )
                        tmpData['dns'] = result
                    self.vms.append(tmpData)
        except Exception as e:
            if e.args[0] is dict:
                raise Exception(e)
            else:
                raise Exception({
                    'error': "Unknown error while creating Vms: {}"
                    .format(str(e))
                })
                # raise Exception(e)

    def createLoadBalancer(self, lbName, lbDetails, provider, lbQueue, errors):
        """Create One loadbalancer and it's dependent Servers."""
        # Create LB here
        try:
            print("Creating LB: {}".format(lbName))
            lbData = provider.loadBalancer(
                lbDetails['load_balancer'],
                self.tags
            )
            lbDetails['servers']['beId'] = lbData['lbInfo'] \
                .backend_address_pools[0].id
            # Create a single item list so we can re-use createVms
            serverList = list()
            serverList.append(lbDetails['servers'])
            self.createVms(serverList, provider)
            record = self.tags['uuid']
            if 'domain' in lbDetails['load_balancer']:
                record = lbDetails['load_balancer']['domain'] + '-' + record
            else:
                record = lbDetails['load_balancer']['name'] + '-' + record

            result = provider.addDNS(
                lbData['publicIp'].ip_address,
                record
            )
            for vm in self.vms:
                if vm['servers'] == lbDetails['load_balancer']['be_servers']:
                    lbQueue.put({
                        lbDetails['load_balancer']['name']: result,
                        'vms': vm
                    })
        except Exception as e:
            print("Error creating LB {}".format(str(e)))
            errors.put(Exception(e))

    def validateLoadBalancer(self, lb):
        """Validate a LB's config."""
        validate = False
        if lb['health_protocol'] == 'Tcp' or \
                lb['health_protocol'] == 'Http':
            if lb['health_protocol'] == 'Http':
                if 'health_path' not in lb:
                    e = {
                        'error': "Must specify health_path with Http"
                    }
                    raise Exception(e)
            validate = True
        else:
            e = {
                'error': "health_protocol must be 'Http' or 'Tcp'"
            }
            raise Exception(e)

        return validate

    def createLoadBalancers(self, data, provider):
        """Create Load balancers."""
        print("Creating Load Balancers")
        lbQueue = Queue()
        errors = Queue()
        lbProcList = list()
        try:
            for item in data:
                for lbName, details in item.items():
                    # For each LB Spawn a child process
                    if self.validateLoadBalancer(details['load_balancer']):
                        p = Process(
                            target=self.createLoadBalancer,
                            args=(lbName, details, provider, lbQueue, errors)
                        )
                        lbProcList.append(p)
                        p.start()
            for proc in lbProcList:
                try:
                    proc.join(600)
                except:
                    proc.terminate()
                    raise
                if not errors.empty():
                    # If it's not empty there's an error
                    raise {
                        'error': "Error in child process for LB: {}"
                        .format(errors.get()),
                        'code': 500
                    }
                if lbQueue.empty():
                    raise Exception({
                        'error': "Time out creating LB",
                        'code': 500
                    })
                else:
                    tmpData = lbQueue.get()
                    self.lbs.append(tmpData)
        except Exception as e:
            if e.args[0] is dict:
                raise Exception(e)
            else:
                raise Exception({
                    'error': "Unknown error while creating LBs: {}"
                    .format(str(e))
                })

    def createEnvironment(self, data):
        """Create an Environment.

        From a Infrastructure template create an environment.
        """
        if 'infrastructureTemplateID' in data:
            template = self.templates.loadTemplate(
                data['infrastructureTemplateID']
            )
        else:
            raise Exception({
                'error': 'infrastructureTemplateID must be provided',
                'code': 400
            })
        if 'id' in data:
            if Helpers.validString(data['id']):
                if self.checkUUIDInUse(data['id']):
                    raise Exception({'error': 'UUID in use', 'code': 412})
            else:
                raise Exception({
                    'error': 'UUID is not valid, must be [a-z0-9-]',
                    'code': 412
                })
        else:
            raise Exception({'error': 'ID must be provided', 'code': 400})
        if 'application' in data:
            # This should never happen as the check for UUID should throw first
            if self.checkJenkinsRunning(data['application'], data['id']):
                raise Exception({
                    'error': 'Jenkins build running already',
                    'code': 409
                })

        response = list()
        self.tags['uuid'] = data['id']
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            template,
            data['id']
        )
        if 'error' in provider.credentials:
            raise Exception({
                'error': provider.credentials['error'],
                'code': 400}
            )

        buildMap = {
            "servers": self.createVms,
            "networks": self.createNetworks,
            "load_balancers": self.createLoadBalancers,
            "tags": self.setTags
        }
        # Build core resources
        print("Creating RG")
        provider.createResourceGroup()
        print("Creating SA")
        provider.createStorageAccount()
        try:
            for resource in provider.resources['resources']:
                for k, v in resource.items():
                    if k in buildMap:
                        if k == 'tags':
                            buildMap[k](v)
                        else:
                            buildMap[k](v, provider)
                        continue
        except:
            raise

        for vmRsp in self.vms:
            response.append(vmRsp)

        # By this point an environment should be created so Execute Jenkins job
        if 'application' in data:
            self.runJenkinsPipeline(data['application'])

            if 'gitlab' in data:
                glResponse = self.runGitlabTasks(
                    data['gitlab'],
                    data['application']
                )
                response.append({'gitlab': glResponse})
        if self.lbs:
            response.append({'loadBalancers': self.lbs})
        return {'msg': {'Resources': response}, 'code': 201}

    def listEnvironments(self):
        """Return a list of environments."""
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name']
        )

        return {'msg': {"Environments": provider.getResources()}, 'code': 200}

    def deleteEnvironment(self, data):
        """Delete a specific Environments Resources."""
        if not self.checkUUIDInUse(data['uuid']):
            raise Exception({'error': 'Invalid UUID', 'code': 404})
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name']
        )
        print("Deleting Resources")
        deleteResources = {'Azure': provider.getResources(data['uuid'])}
        glServerConn = self.config.credentials['gitlab']['url']
        glServerToken = self.config.credentials['gitlab']['token']
        glServer = Gitlab(glServerConn, glServerToken)
        user = glServer.getUser(data['uuid'])
        if user:
            deleteResources['Gitlab'] = user

        if "ids" in deleteResources["Azure"]:
            provider.deleteResourceById(deleteResources["Azure"]["ids"])
        if "vhds" in deleteResources["Azure"]:
            provider.deleteStorageAccountContainer(data['uuid'])
        if "dns" in deleteResources["Azure"]:
            provider.deleteDNSRecord(deleteResources["Azure"]["dns"])
        if "Gitlab" in deleteResources:
            glServer.deleteUser(user)

        return {'code': 204, 'msg': None}

    def rebuildEnvironmentServer(self, data):
        """Rebuild a portion of an environment.

        Given a specified 'server' group delete and recreate those servers.
        """
        if 'infrastructureTemplateID' in data:
            template = self.templates.loadTemplate(
                data['infrastructureTemplateID']
            )
            templateCopy = deepcopy(template)
        else:
            raise Exception({
                'error': 'infrastructureTemplateID must be provided',
                'code': 400
            })
        if 'uuid' in data:
            if not self.checkUUIDInUse(data['uuid']):
                raise Exception({'error': 'Invalid UUID', 'code': 404})
        else:
            raise Exception({'error': 'ID must be provided', 'code': 400})
        if 'application' in data:
            if self.checkJenkinsRunning(data['application'], data['uuid']):
                raise Exception({
                    'error': 'Jenkins build running already',
                    'code': 409
                })

        response = list()
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            template,
            data['uuid']
        )
        print("Rebuilding: {}".format(data['servers']))
        resources = provider.getResources(id=data['uuid'], filter={
            'key': 'type',
            'value': data['servers']
        })

        vmDetails = list()
        if 'ids' in resources:
            for vm in resources['ids']:
                vmDetails.append(self.getVMDetails(vm, data['servers']))

            # Delete Resources
            provider.deleteResourceById(resources['ids'])
        else:
            vmDetails.append({'type': data['servers']})

        persistData = False
        if 'vhds' in resources:
            if data["persistData"]:
                persistData = data['persistData']
                # Delete OS Disks
                delDisks = list()
                for disk in resources['vhds']:
                    if 'data' not in disk:
                        delDisks.append(disk)
                if delDisks:
                    provider.deleteStorageAccountDisk(data['uuid'], delDisks)
            else:
                print("persistData False")
                # Delete All Disks
                provider.deleteStorageAccountDisk(
                    data['uuid'],
                    resources['vhds']
                )

        count = None
        if 'ids' in resources:
            count = len(resources['ids'])

        self.addVM(
            vmDetails,
            provider,
            templateCopy,
            data['uuid'],
            data['application'],
            count=count,
            persistData=persistData
        )
        for vmRsp in self.vms:
            response.append(vmRsp)
        return {'msg': {'Resources': response}, 'code': 200}

    def scaleEnvironmentServer(self, data):
        """Scale an Environments servers."""
        if 'infrastructureTemplateID' in data:
            template = self.templates.loadTemplate(
                data['infrastructureTemplateID']
            )
            templateCopy = deepcopy(template)
        else:
            raise Exception({
                'error': 'infrastructureTemplateID must be provided',
                'code': 400
            })
        if 'uuid' in data:
            if not self.checkUUIDInUse(data['uuid']):
                raise Exception({'error': 'Invalid UUID', 'code': 404})
        else:
            raise Exception({'error': 'ID must be provided', 'code': 400})
        if 'application' in data:
            if self.checkJenkinsRunning(data['application'], data['uuid']):
                raise Exception({
                    'error': 'Jenkins build running already',
                    'code': 409
                })

        response = list()
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            template,
            data['uuid']
        )

        resources = provider.getResources(id=data['uuid'], filter={
            'key': 'type',
            'value': data['servers']
        })
        currentSize = 0
        vms = list()
        if 'ids' in resources:
            currentSize = len(resources['ids'])
            for vm in resources['ids']:
                vms.append(self.getVMDetails(vm, data['servers']))
        else:
            vms.append({'server': data['servers']})
        response.append(vms)
        print("Scalling: {} from {} to {}".format(
            data['servers'],
            currentSize,
            data['count']
        ))

        if currentSize < data['count']:
            # Scale up
            self.addVM(
                vms,
                provider,
                templateCopy,
                data['uuid'],
                data['application'],
                count=data['count']
            )
        elif currentSize > data['count']:
            # Scale down
            deleteIds = list()
            deleteDisks = list()
            while len(vms) > data['count']:
                deleteIds.append(vms[-1]['id'])
                for disk in resources['vhds']:
                    if vms[-1]['name'] in disk:
                        deleteDisks.append(disk)
                vms.remove(vms[-1])
            provider.deleteResourceById(deleteIds)
            provider.deleteStorageAccountDisk(
                data['uuid'],
                deleteDisks
            )

        for vmRsp in self.vms:
            response.append(vmRsp)
        return {'msg': {'Resources': response}, 'code': 200}

    def environmentStatus(self, data):
        """Get the status of an environment."""
        if 'infrastructureTemplateID' in data:
            template = self.templates.loadTemplate(
                data['infrastructureTemplateID']
            )
        else:
            raise Exception({
                'error': 'infrastructureTemplateID must be provided',
                'code': 400
            })
        if 'uuid' in data:
            if not self.checkUUIDInUse(data['uuid']):
                raise Exception({'error': 'Invalid UUID', 'code': 404})
        else:
            raise Exception({'error': 'ID must be provided', 'code': 400})

        statusResoures = list()
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            template,
            data['uuid']
        )
        print("Getting Status")
        deploymentResources = provider.resources
        resources = provider.getResources(id=data['uuid'])
        if 'ids' in resources:
            statusResoures.append({
                'Environment resources':
                self.getStatusById(resources['ids'], provider)
            })
        if 'dns' in resources:
            dnsEntry = list()
            for entry in resources['dns']:
                dnsEntry.append({
                    'name': entry,
                    'type': 'Microsoft.Network/dnsZones',
                    'status': 'Succeeded'
                })
            statusResoures.append({'Shared resources': dnsEntry})
        if 'vhds' in resources:
            vhdEntry = list()
            for vhd in resources['vhds']:
                vhdEntry.append({
                    'name': vhd,
                    'type': 'Microsoft.Stroage/blobStorage',
                    'status': 'Succeeded'
                })
            statusResoures.append({
                'Storage resources': vhdEntry
            })
        if 'application' in data:
            jenkinsStatus = self.getJenkinsBuildStatus(
                data['application'],
                data['uuid']
            )
            statusResoures.append({
                'Build resources': jenkinsStatus
            })

        broken = self.compareResources(
            statusResoures,
            deploymentResources,
            data['uuid']
        )
        response = {
            'Resources': statusResoures,
            'status': "Succeeded"
        }
        if broken:
            statusResoures.append({
                'Broken resources': broken
            })
            response['status'] = "Failed"

        return {'msg': response, 'code': 200}

    def environmentServerStopStart(self, data, action):
        """Stop or Start an environment."""
        if not self.checkUUIDInUse(data['uuid']):
            raise Exception({'error': 'Invalid UUID', 'code': 404})
        if 'application' in data:
            if self.checkJenkinsRunning(data['application'], data['uuid']):
                raise Exception({
                    'error': 'Jenkins build running already',
                    'code': 409
                })
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            id=data['uuid']
        )
        VMList = self.getVmList(provider, data['uuid'], data['servers'])

        outcome = {
            'stop': 'VM running',
            'start': 'VM stopped'
        }
        actions = {
            'stop': self.stopVM,
            'start': self.startVM
        }

        for vm in VMList:
            if vm['status'] == outcome[action]:
                actions[action](provider, vm)
        statuses = self.getVmList(provider, data['uuid'], data['servers'])
        return {'msg': {'VMs': statuses}, 'code': 200}
</code></pre>
  </div>

  </header>

  <section id="section-items">


    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="platforminfra.controller.Controller" class="name">class <span class="ident">Controller</span></p>
      
  
    <div class="desc"><p>Controls the platformInfra.</p>
<p>The controller Object carries out all of the actions.
As this expands it will be neccessary to move the control of the
infrastructure into its own module. For now the boundaries between Control
and provider are blurred. The provider works on the resource and sometimes
<em>with</em> the resource whereas the controller only works <em>with</em> the resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller" class="source">
    <pre><code>class Controller(object):
    """Controls the platformInfra.

    The controller Object carries out all of the actions.
    As this expands it will be neccessary to move the control of the
    infrastructure into its own module. For now the boundaries between Control
    and provider are blurred. The provider works on the resource and sometimes
    *with* the resource whereas the controller only works *with* the resource.
    """

    def __init__(self):
        """Initialise the controller."""
        self.templates = Template(templateDir='./templates/')
        self.tags = dict()
        self.subnets = list()
        self.vms = list()
        self.lbs = list()
        self.config = Config()

    def getTemplate(self, templateName):
        """Get a Template by Name."""
        return self.templates.loadTemplate(templateName)

    def setTags(self, data):
        """Create the tags property."""
        print("Creating Tags")
        self.tags = {**self.tags, **data}

    def checkUUIDInUse(self, uuid):
        """Given a UUID validate if it is in use or not."""
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name']
        )

        uuids = provider.getResources()
        if uuid in uuids:
            return True
        else:
            return False

    def getResourceDetails(self, id):
        """Get a VM object back from an ID."""
        resource = dict()
        resource['id'] = id
        idSplit = re.split(r"/", id.strip())
        resource['name'] = idSplit[-1]
        resource['type'] = idSplit[6] + "/" + idSplit[7]
        resource['group'] = idSplit[4]

        return resource

    def getVmList(self, provider, uuid, server):
        """Return a list of VM's and their current running state."""
        resources = provider.getResources(id=uuid, filter={
            'key': 'type',
            'value': server
        })
        if 'ids' in resources:
            statuses = self.getStatusById(resources['ids'], provider)
            return statuses
        else:
            raise Exception({
                'error': "No VM Resources found for {} in {}".format(
                    server,
                    uuid
                ),
                'code': 404
            })

    def getVMDetails(self, id, server):
        """Get a VM object back from an ID."""
        vm = dict()
        vm['id'] = id
        idSplit = re.split(r"/", id.strip())
        vm['name'] = idSplit[-1]
        vm['type'] = idSplit[6] + "/" + idSplit[7]
        vm['server'] = server
        countSplit = re.split(r"{}".format(type), vm['name'].strip())
        vm['position'] = countSplit[-1]

        return vm

    def getVMBEID(
            self, provider, id=None, template=None,
            server=None, uuid=None
            ):
        """For an ID get the BE ID."""
        beId = None
        if template and uuid and server:
            if 'load_balancers' in template['services']:
                for lb in template['services']['load_balancers']:
                    if lb['be_servers'] == server:
                        lbName = lb['name']
                        resources = provider.getResources(id=uuid)
                        for id in resources['ids']:
                            idSplit = re.split(r"/", id.strip())
                            resourceType = idSplit[6] + "/" + idSplit[7]
                            resourceName = idSplit[-1]
                            lbResName = 'Microsoft.Network/loadBalancers'
                            if resourceType == lbResName and \
                                    lbName in resourceName:
                                print("Getting LB")
                                # Found the Id of the Load balancer
                                # for the server
                                lb = provider.getResourceById(resourceType, id)
                                be = lb.properties['backendAddressPools'][0]
                                beId = be['id']
        return beId

    def runJenkinsPipeline(self, pipeline):
        """Run a specified Jenkins pipeline."""
        jenkinsServer = Jenkins(
            self.config.credentials['jenkins']['url'],
            user=self.config.credentials['jenkins']['user'],
            password=self.config.credentials['jenkins']['password']
        )
        print("Running Jenkins Job")
        jenkinsServer.runBuildWithParams(
            pipeline,
            params={
                "UUID": self.tags['uuid']
            }
        )

    def getJenkinsBuildStatus(self, pipeline, uuid):
        """Get a pipeline status for a given uuid."""
        jenkinsServer = Jenkins(
            self.config.credentials['jenkins']['url'],
            user=self.config.credentials['jenkins']['user'],
            password=self.config.credentials['jenkins']['password']
        )
        status = jenkinsServer.getBuildStatus(
            pipeline,
            uuid
        )
        return status

    def checkJenkinsRunning(self, pipeline, uuid):
        """Check a list of responses and return boolean."""
        statuses = self.getJenkinsBuildStatus(pipeline, uuid)
        running = False
        for status in statuses:
            if status['status'] == 'RUNNING':
                running = True
        return running

    def runGitlabTasks(self, gitlab, app):
        """Run the required actrions for Gitlab creation."""
        response = dict()
        print("Connecting to Gitlab")
        glServerConn = self.config.credentials['gitlab']['url']
        glServerToken = self.config.credentials['gitlab']['token']
        glSourceTeam = "root"
        glServer = Gitlab(glServerConn, glServerToken)

        print("Create user")
        password = Helpers.randStr(10)
        if 'password' in gitlab['user']:
            password = gitlab['user']['password']
        user = glServer.createUser(
            self.tags['uuid'],
            self.tags['uuid'],
            password,
            self.tags['uuid'] + '@example.net'
        )
        print("Adding SSH key for User")
        if 'sshKey' in gitlab['user']:
            key = glServer.addSshKey(user, gitlab['user']['sshKey'])
            if type(key) is dict:
                if 'error' in key:
                    raise Exception(key)
        response['user'] = user.username
        print("Cloning Repos")
        if 'cloneRepos' in gitlab:
            response['repos'] = dict()
            for repo in gitlab['cloneRepos']:
                glSourceProject = glServer.getProject(glSourceTeam, repo)
                if type(glSourceProject) is dict:
                    if 'error' in glSourceProject:
                        raise Exception(glSourceProject)
                forked = glServer.forkProject(
                    user.username,
                    glSourceProject.id
                )
                if type(forked) is dict:
                    if 'error' in forked:
                        raise Exception(forked)
                print("Getting the SSH url for the repo")
                response['repos'][repo] = {
                    'ssh': forked.ssh_url_to_repo,
                    'web': forked.http_url_to_repo
                }
                print("Granting access to forked repo")
                member = glServer.addUserToProjectMembers(user, forked)
                if type(member) is dict:
                    if 'error' in member:
                        raise Exception(member)
                print("Hooking it up")
                hook = glServer.addHook(
                    self.config.credentials['jenkins']['url'] +
                    "/project/{}/".format(app),
                    forked
                )
                if type(hook) is dict:
                    if 'error' in hook:
                        raise Exception(hook)

        return response

    def addVM(
            self, vms, provider, template, uuid, application=None,
            count=None, persistData=False
            ):
        """Given an Existing list of VMs Add more."""
        if not count:
            for server in template['services']['servers']:
                if server['name'] == vms[0]['server']:
                    count = server['count']
        vm = dict()
        vm['count'] = count
        print("Getting BE ID")
        beId = self.getVMBEID(
            provider,
            template=template,
            server=vms[0]['server'],
            uuid=uuid
        )
        if 'id' in vms[0]:
            existingIds = list()
            for item in vms:
                if provider.checkResourceExistById(
                    'Microsoft.Compute/virtualMachines',
                    item['id']
                ):
                    existingIds.append(item['id'])
            vm['existing'] = existingIds
        if beId:
            vm['beId'] = beId
        vm['name'] = vms[0]['server']
        vmList = [vm]
        # There's only a single subnet per network
        netName = template['services']['networks'][0]['name']
        subnet = provider.getSubnetID(uuid + netName + "0")
        self.tags['uuid'] = uuid
        self.subnets.append({'subnets': {uuid: subnet}})
        self.createVms(vmList, provider, persistData)

        if 'application':
            self.runJenkinsPipeline(application)

    def getStatusById(self, ids, provider):
        """Get the status of a resource."""
        statuses = list()
        for id in ids:
            details = self.getResourceDetails(id)
            item = provider.getResourceById(details['type'], details['id'])
            if 'provisioningState' in item.properties:
                tmpItem = {
                    'name': details['name'],
                    'type': details['type'],
                    'resourceGroup': details['group'],
                    'provisioningState': item.properties['provisioningState']
                }
                if item.type == "Microsoft.Compute/virtualMachines":
                    vmData = provider.getVmInfo(
                        item.name,
                        item.id,
                        details['group']
                    )
                    for status in vmData.instance_view.statuses:
                        if 'PowerState' in status.code:
                            tmpItem['status'] = status.display_status
                    disks = list()
                    for disk in vmData.instance_view.disks:
                        for status in disk.statuses:
                            disks.append({
                                "name": disk.name,
                                "provisioningState": status.display_status
                            })
                    tmpItem['disks'] = disks
            else:
                if details['type'] == 'Microsoft.Compute/availabilitySets':
                    tmpItem = {
                        'name': details['name'],
                        'type': details['type'],
                        'resourceGroup': details['group'],
                        'provisioningState': 'Succeeded'
                    }
                else:
                    tmpItem = {
                        'name': details['name'],
                        'type': details['type'],
                        'resourceGroup': details['group'],
                        'provisioningState': 'Unknown'
                    }
            statuses.append(tmpItem)
        return statuses

    def checkVMResources(self, vmName, resources):
        """Given a VM Name does it have the right resources."""
        vm = dict()
        vm['vm'] = False
        vm['nic'] = False
        vm['pip'] = False
        vm['disks'] = False
        vm['name'] = vmName
        for resource in resources:
            if resource['type'] == "Microsoft.Compute/virtualMachines"\
                    and vmName in resource['name']:
                    if resource['provisioningState'] == 'Succeeded':
                        vm['vm'] = True
                    disks = list()
                    for disk in resource['disks']:
                        if 'succeeded' in disk['provisioningState']:
                            disks.append(True)
                        else:
                            disks.append(False)
                    if all(disks):
                        vm['disks'] = True

            if resource['type'] == "Microsoft.Network/networkInterfaces"\
                    and vmName in resource['name']:
                    vm['nic'] = True
            if resource['type'] == "Microsoft.Network/publicIPAddresses"\
                    and vmName in resource['name']:
                    vm['pip'] = True
        return vm

    def compareResources(self, statusRes, deploymentRes, uuid):
        """Compare a status list with the Deployment resources.

        Loop through the expected resources (deploymnetRes) and ensure at least
        one of each is found in the statusRes so we inform the request if all
        resources are 'okay' or not.
        """
        deployNetworkCount = list()
        for resource in deploymentRes['resources']:
            if 'networks' in resource:
                for network in resource['networks']:
                    deployNetworkCount.append(network['name'])
        statusNetworkCount = list()
        statusVmCount = list()
        for i in statusRes:
            if "Environment resources" in i:
                for resource in i["Environment resources"]:
                    if resource['type'] == "Microsoft.Network/virtualNetworks":
                        statusNetworkCount.append(resource['name'])
                    if resource['type'] == "Microsoft.Compute/virtualMachines":
                        statusVmCount.append(self.checkVMResources(
                                resource['name'],
                                i["Environment resources"]
                            )
                        )
        # Create a list of all of the broken resources so they can be eaisly
        # displayed within the status response.
        brokenResources = list()
        for vm in statusVmCount:
            # If a VM Does not have these it is not 'good'
            if not (vm['vm'] and vm['nic'] and vm['pip'] and vm['disks']):
                print("VM {} is broken".format(vm['name']))
                brokenResources.append({
                    'name': vm['name'],
                    'type': "Microsoft.Compute/virtualMachines",
                    'status': "Failed"
                })

        for network in deployNetworkCount:
            for statusNetwork in statusNetworkCount:
                if network not in statusNetwork:
                    brokenResources.append({
                        'name': network,
                        'type': "Microsoft.Network/virtualNetworks",
                        'status': "Failed"
                    })

        return brokenResources

    def createNetworks(self, data, provider):
        """Create Networks."""
        # Must complete before everything else is built
        subNets = Queue()
        errors = Queue()
        print("Creating network")
        netProcs = list()
        try:
            for idx, network in enumerate(data):
                netId = str(self.tags['uuid'])+network['name']+str(idx)
                p = Process(
                    target=provider.network,
                    args=(network, netId, self.tags, subNets, errors)
                )
                netProcs.append(p)
                p.start()

            subnets = dict()
            for proc in netProcs:
                try:
                    proc.join(600)
                except:
                    proc.terminate()
                    raise
                if not errors.empty():
                    # If it's not empty there's an error
                    raise Exception({
                        'error': "Error in child process for networking: {}"
                        .format(errors.get()),
                        'code': 500
                    })
                if subNets.empty():
                    raise Exception({
                        'error': "Time out creating network",
                        'code': 500
                    })
                else:
                    subnets['subnets'] = subNets.get()
        except Exception as e:
            if e.args[0] is dict:
                raise Exception(e)
            else:
                raise Exception({
                    'error': "Unknown error while creating networks: {}"
                    .format(str(e))
                })

        self.subnets.append(subnets)

    def stopVM(self, provider, vm):
        """Stop a running VM."""
        provider.stopVm(vm['name'], vm['resourceGroup'])

    def startVM(self, provider, vm):
        """Start a stopped VM."""
        provider.startVm(vm['name'], vm['resourceGroup'])

    def createVms(self, data, provider, persistData=False):
        """Create VMs.

        For a given set of data, for each 'server' group create each server
        with all of dependencies each VM needs.
        """
        print("Creating Servers")
        vms = Queue()
        errors = Queue()
        vmLock = Lock()
        # Processes that can be run in parrallel
        serverProcs = list()
        try:
            for i in self.subnets:
                if self.tags['uuid'] in i['subnets']:
                    # Grab A subnet - needs reworking when multiple networks is
                    # supported
                    vmSubnet = i['subnets'][self.tags['uuid']]
            for server in data:
                # For each 'server' Spawn a process to create that vm
                p = Process(
                    target=provider.virtualMachine,
                    args=(
                        server,
                        self.tags,
                        vmSubnet,
                        vms,
                        vmLock,
                        errors,
                        persistData
                    )
                )
                vmDetails = {
                    'servers': server['name'],
                    'process': p
                }
                if 'dns' in server:
                    vmDetails['dns'] = server['dns']
                serverProcs.append(vmDetails)
                p.start()

            for proc in serverProcs:
                try:
                    proc['process'].join(600)
                except:
                    proc['process'].terminate()
                    raise
                if not errors.empty():
                    # If it's not empty there's an error
                    print("Errors not empty")
                    raise Exception({
                        'error': "Error in child process for VM: {}"
                        .format(errors.get()),
                        'code': 500
                    })
                if vms.empty():
                    print("vms empty")
                    raise Exception({
                        'error': "Time out creating VMs",
                        'code': 500
                    })
                else:
                    tmpData = vms.get()
                    if 'dns' in proc:
                        # Only apply to the first server
                        result = provider.addDNS(
                            tmpData['vms'][0]['public_ip'],
                            proc['dns'] + '-' + self.tags['uuid']
                        )
                        tmpData['dns'] = result
                    self.vms.append(tmpData)
        except Exception as e:
            if e.args[0] is dict:
                raise Exception(e)
            else:
                raise Exception({
                    'error': "Unknown error while creating Vms: {}"
                    .format(str(e))
                })
                # raise Exception(e)

    def createLoadBalancer(self, lbName, lbDetails, provider, lbQueue, errors):
        """Create One loadbalancer and it's dependent Servers."""
        # Create LB here
        try:
            print("Creating LB: {}".format(lbName))
            lbData = provider.loadBalancer(
                lbDetails['load_balancer'],
                self.tags
            )
            lbDetails['servers']['beId'] = lbData['lbInfo'] \
                .backend_address_pools[0].id
            # Create a single item list so we can re-use createVms
            serverList = list()
            serverList.append(lbDetails['servers'])
            self.createVms(serverList, provider)
            record = self.tags['uuid']
            if 'domain' in lbDetails['load_balancer']:
                record = lbDetails['load_balancer']['domain'] + '-' + record
            else:
                record = lbDetails['load_balancer']['name'] + '-' + record

            result = provider.addDNS(
                lbData['publicIp'].ip_address,
                record
            )
            for vm in self.vms:
                if vm['servers'] == lbDetails['load_balancer']['be_servers']:
                    lbQueue.put({
                        lbDetails['load_balancer']['name']: result,
                        'vms': vm
                    })
        except Exception as e:
            print("Error creating LB {}".format(str(e)))
            errors.put(Exception(e))

    def validateLoadBalancer(self, lb):
        """Validate a LB's config."""
        validate = False
        if lb['health_protocol'] == 'Tcp' or \
                lb['health_protocol'] == 'Http':
            if lb['health_protocol'] == 'Http':
                if 'health_path' not in lb:
                    e = {
                        'error': "Must specify health_path with Http"
                    }
                    raise Exception(e)
            validate = True
        else:
            e = {
                'error': "health_protocol must be 'Http' or 'Tcp'"
            }
            raise Exception(e)

        return validate

    def createLoadBalancers(self, data, provider):
        """Create Load balancers."""
        print("Creating Load Balancers")
        lbQueue = Queue()
        errors = Queue()
        lbProcList = list()
        try:
            for item in data:
                for lbName, details in item.items():
                    # For each LB Spawn a child process
                    if self.validateLoadBalancer(details['load_balancer']):
                        p = Process(
                            target=self.createLoadBalancer,
                            args=(lbName, details, provider, lbQueue, errors)
                        )
                        lbProcList.append(p)
                        p.start()
            for proc in lbProcList:
                try:
                    proc.join(600)
                except:
                    proc.terminate()
                    raise
                if not errors.empty():
                    # If it's not empty there's an error
                    raise {
                        'error': "Error in child process for LB: {}"
                        .format(errors.get()),
                        'code': 500
                    }
                if lbQueue.empty():
                    raise Exception({
                        'error': "Time out creating LB",
                        'code': 500
                    })
                else:
                    tmpData = lbQueue.get()
                    self.lbs.append(tmpData)
        except Exception as e:
            if e.args[0] is dict:
                raise Exception(e)
            else:
                raise Exception({
                    'error': "Unknown error while creating LBs: {}"
                    .format(str(e))
                })

    def createEnvironment(self, data):
        """Create an Environment.

        From a Infrastructure template create an environment.
        """
        if 'infrastructureTemplateID' in data:
            template = self.templates.loadTemplate(
                data['infrastructureTemplateID']
            )
        else:
            raise Exception({
                'error': 'infrastructureTemplateID must be provided',
                'code': 400
            })
        if 'id' in data:
            if Helpers.validString(data['id']):
                if self.checkUUIDInUse(data['id']):
                    raise Exception({'error': 'UUID in use', 'code': 412})
            else:
                raise Exception({
                    'error': 'UUID is not valid, must be [a-z0-9-]',
                    'code': 412
                })
        else:
            raise Exception({'error': 'ID must be provided', 'code': 400})
        if 'application' in data:
            # This should never happen as the check for UUID should throw first
            if self.checkJenkinsRunning(data['application'], data['id']):
                raise Exception({
                    'error': 'Jenkins build running already',
                    'code': 409
                })

        response = list()
        self.tags['uuid'] = data['id']
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            template,
            data['id']
        )
        if 'error' in provider.credentials:
            raise Exception({
                'error': provider.credentials['error'],
                'code': 400}
            )

        buildMap = {
            "servers": self.createVms,
            "networks": self.createNetworks,
            "load_balancers": self.createLoadBalancers,
            "tags": self.setTags
        }
        # Build core resources
        print("Creating RG")
        provider.createResourceGroup()
        print("Creating SA")
        provider.createStorageAccount()
        try:
            for resource in provider.resources['resources']:
                for k, v in resource.items():
                    if k in buildMap:
                        if k == 'tags':
                            buildMap[k](v)
                        else:
                            buildMap[k](v, provider)
                        continue
        except:
            raise

        for vmRsp in self.vms:
            response.append(vmRsp)

        # By this point an environment should be created so Execute Jenkins job
        if 'application' in data:
            self.runJenkinsPipeline(data['application'])

            if 'gitlab' in data:
                glResponse = self.runGitlabTasks(
                    data['gitlab'],
                    data['application']
                )
                response.append({'gitlab': glResponse})
        if self.lbs:
            response.append({'loadBalancers': self.lbs})
        return {'msg': {'Resources': response}, 'code': 201}

    def listEnvironments(self):
        """Return a list of environments."""
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name']
        )

        return {'msg': {"Environments": provider.getResources()}, 'code': 200}

    def deleteEnvironment(self, data):
        """Delete a specific Environments Resources."""
        if not self.checkUUIDInUse(data['uuid']):
            raise Exception({'error': 'Invalid UUID', 'code': 404})
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name']
        )
        print("Deleting Resources")
        deleteResources = {'Azure': provider.getResources(data['uuid'])}
        glServerConn = self.config.credentials['gitlab']['url']
        glServerToken = self.config.credentials['gitlab']['token']
        glServer = Gitlab(glServerConn, glServerToken)
        user = glServer.getUser(data['uuid'])
        if user:
            deleteResources['Gitlab'] = user

        if "ids" in deleteResources["Azure"]:
            provider.deleteResourceById(deleteResources["Azure"]["ids"])
        if "vhds" in deleteResources["Azure"]:
            provider.deleteStorageAccountContainer(data['uuid'])
        if "dns" in deleteResources["Azure"]:
            provider.deleteDNSRecord(deleteResources["Azure"]["dns"])
        if "Gitlab" in deleteResources:
            glServer.deleteUser(user)

        return {'code': 204, 'msg': None}

    def rebuildEnvironmentServer(self, data):
        """Rebuild a portion of an environment.

        Given a specified 'server' group delete and recreate those servers.
        """
        if 'infrastructureTemplateID' in data:
            template = self.templates.loadTemplate(
                data['infrastructureTemplateID']
            )
            templateCopy = deepcopy(template)
        else:
            raise Exception({
                'error': 'infrastructureTemplateID must be provided',
                'code': 400
            })
        if 'uuid' in data:
            if not self.checkUUIDInUse(data['uuid']):
                raise Exception({'error': 'Invalid UUID', 'code': 404})
        else:
            raise Exception({'error': 'ID must be provided', 'code': 400})
        if 'application' in data:
            if self.checkJenkinsRunning(data['application'], data['uuid']):
                raise Exception({
                    'error': 'Jenkins build running already',
                    'code': 409
                })

        response = list()
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            template,
            data['uuid']
        )
        print("Rebuilding: {}".format(data['servers']))
        resources = provider.getResources(id=data['uuid'], filter={
            'key': 'type',
            'value': data['servers']
        })

        vmDetails = list()
        if 'ids' in resources:
            for vm in resources['ids']:
                vmDetails.append(self.getVMDetails(vm, data['servers']))

            # Delete Resources
            provider.deleteResourceById(resources['ids'])
        else:
            vmDetails.append({'type': data['servers']})

        persistData = False
        if 'vhds' in resources:
            if data["persistData"]:
                persistData = data['persistData']
                # Delete OS Disks
                delDisks = list()
                for disk in resources['vhds']:
                    if 'data' not in disk:
                        delDisks.append(disk)
                if delDisks:
                    provider.deleteStorageAccountDisk(data['uuid'], delDisks)
            else:
                print("persistData False")
                # Delete All Disks
                provider.deleteStorageAccountDisk(
                    data['uuid'],
                    resources['vhds']
                )

        count = None
        if 'ids' in resources:
            count = len(resources['ids'])

        self.addVM(
            vmDetails,
            provider,
            templateCopy,
            data['uuid'],
            data['application'],
            count=count,
            persistData=persistData
        )
        for vmRsp in self.vms:
            response.append(vmRsp)
        return {'msg': {'Resources': response}, 'code': 200}

    def scaleEnvironmentServer(self, data):
        """Scale an Environments servers."""
        if 'infrastructureTemplateID' in data:
            template = self.templates.loadTemplate(
                data['infrastructureTemplateID']
            )
            templateCopy = deepcopy(template)
        else:
            raise Exception({
                'error': 'infrastructureTemplateID must be provided',
                'code': 400
            })
        if 'uuid' in data:
            if not self.checkUUIDInUse(data['uuid']):
                raise Exception({'error': 'Invalid UUID', 'code': 404})
        else:
            raise Exception({'error': 'ID must be provided', 'code': 400})
        if 'application' in data:
            if self.checkJenkinsRunning(data['application'], data['uuid']):
                raise Exception({
                    'error': 'Jenkins build running already',
                    'code': 409
                })

        response = list()
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            template,
            data['uuid']
        )

        resources = provider.getResources(id=data['uuid'], filter={
            'key': 'type',
            'value': data['servers']
        })
        currentSize = 0
        vms = list()
        if 'ids' in resources:
            currentSize = len(resources['ids'])
            for vm in resources['ids']:
                vms.append(self.getVMDetails(vm, data['servers']))
        else:
            vms.append({'server': data['servers']})
        response.append(vms)
        print("Scalling: {} from {} to {}".format(
            data['servers'],
            currentSize,
            data['count']
        ))

        if currentSize < data['count']:
            # Scale up
            self.addVM(
                vms,
                provider,
                templateCopy,
                data['uuid'],
                data['application'],
                count=data['count']
            )
        elif currentSize > data['count']:
            # Scale down
            deleteIds = list()
            deleteDisks = list()
            while len(vms) > data['count']:
                deleteIds.append(vms[-1]['id'])
                for disk in resources['vhds']:
                    if vms[-1]['name'] in disk:
                        deleteDisks.append(disk)
                vms.remove(vms[-1])
            provider.deleteResourceById(deleteIds)
            provider.deleteStorageAccountDisk(
                data['uuid'],
                deleteDisks
            )

        for vmRsp in self.vms:
            response.append(vmRsp)
        return {'msg': {'Resources': response}, 'code': 200}

    def environmentStatus(self, data):
        """Get the status of an environment."""
        if 'infrastructureTemplateID' in data:
            template = self.templates.loadTemplate(
                data['infrastructureTemplateID']
            )
        else:
            raise Exception({
                'error': 'infrastructureTemplateID must be provided',
                'code': 400
            })
        if 'uuid' in data:
            if not self.checkUUIDInUse(data['uuid']):
                raise Exception({'error': 'Invalid UUID', 'code': 404})
        else:
            raise Exception({'error': 'ID must be provided', 'code': 400})

        statusResoures = list()
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            template,
            data['uuid']
        )
        print("Getting Status")
        deploymentResources = provider.resources
        resources = provider.getResources(id=data['uuid'])
        if 'ids' in resources:
            statusResoures.append({
                'Environment resources':
                self.getStatusById(resources['ids'], provider)
            })
        if 'dns' in resources:
            dnsEntry = list()
            for entry in resources['dns']:
                dnsEntry.append({
                    'name': entry,
                    'type': 'Microsoft.Network/dnsZones',
                    'status': 'Succeeded'
                })
            statusResoures.append({'Shared resources': dnsEntry})
        if 'vhds' in resources:
            vhdEntry = list()
            for vhd in resources['vhds']:
                vhdEntry.append({
                    'name': vhd,
                    'type': 'Microsoft.Stroage/blobStorage',
                    'status': 'Succeeded'
                })
            statusResoures.append({
                'Storage resources': vhdEntry
            })
        if 'application' in data:
            jenkinsStatus = self.getJenkinsBuildStatus(
                data['application'],
                data['uuid']
            )
            statusResoures.append({
                'Build resources': jenkinsStatus
            })

        broken = self.compareResources(
            statusResoures,
            deploymentResources,
            data['uuid']
        )
        response = {
            'Resources': statusResoures,
            'status': "Succeeded"
        }
        if broken:
            statusResoures.append({
                'Broken resources': broken
            })
            response['status'] = "Failed"

        return {'msg': response, 'code': 200}

    def environmentServerStopStart(self, data, action):
        """Stop or Start an environment."""
        if not self.checkUUIDInUse(data['uuid']):
            raise Exception({'error': 'Invalid UUID', 'code': 404})
        if 'application' in data:
            if self.checkJenkinsRunning(data['application'], data['uuid']):
                raise Exception({
                    'error': 'Jenkins build running already',
                    'code': 409
                })
        provider = Azure(
            self.config.credentials['azure'],
            self.config.defaults['resource_group_name'],
            self.config.defaults['storage_account_name'],
            id=data['uuid']
        )
        VMList = self.getVmList(provider, data['uuid'], data['servers'])

        outcome = {
            'stop': 'VM running',
            'start': 'VM stopped'
        }
        actions = {
            'stop': self.stopVM,
            'start': self.startVM
        }

        for vm in VMList:
            if vm['status'] == outcome[action]:
                actions[action](provider, vm)
        statuses = self.getVmList(provider, data['uuid'], data['servers'])
        return {'msg': {'VMs': statuses}, 'code': 200}
</code></pre>
  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#platforminfra.controller.Controller">Controller</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Initialise the controller.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.__init__', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.__init__" class="source">
    <pre><code>def __init__(self):
    """Initialise the controller."""
    self.templates = Template(templateDir='./templates/')
    self.tags = dict()
    self.subnets = list()
    self.vms = list()
    self.lbs = list()
    self.config = Config()
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.addVM">
    <p>def <span class="ident">addVM</span>(</p><p>self, vms, provider, template, uuid, application=None, count=None, persistData=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Given an Existing list of VMs Add more.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.addVM', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.addVM" class="source">
    <pre><code>def addVM(
        self, vms, provider, template, uuid, application=None,
        count=None, persistData=False
        ):
    """Given an Existing list of VMs Add more."""
    if not count:
        for server in template['services']['servers']:
            if server['name'] == vms[0]['server']:
                count = server['count']
    vm = dict()
    vm['count'] = count
    print("Getting BE ID")
    beId = self.getVMBEID(
        provider,
        template=template,
        server=vms[0]['server'],
        uuid=uuid
    )
    if 'id' in vms[0]:
        existingIds = list()
        for item in vms:
            if provider.checkResourceExistById(
                'Microsoft.Compute/virtualMachines',
                item['id']
            ):
                existingIds.append(item['id'])
        vm['existing'] = existingIds
    if beId:
        vm['beId'] = beId
    vm['name'] = vms[0]['server']
    vmList = [vm]
    # There's only a single subnet per network
    netName = template['services']['networks'][0]['name']
    subnet = provider.getSubnetID(uuid + netName + "0")
    self.tags['uuid'] = uuid
    self.subnets.append({'subnets': {uuid: subnet}})
    self.createVms(vmList, provider, persistData)
    if 'application':
        self.runJenkinsPipeline(application)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.checkJenkinsRunning">
    <p>def <span class="ident">checkJenkinsRunning</span>(</p><p>self, pipeline, uuid)</p>
    </div>
    

    
  
    <div class="desc"><p>Check a list of responses and return boolean.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.checkJenkinsRunning', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.checkJenkinsRunning" class="source">
    <pre><code>def checkJenkinsRunning(self, pipeline, uuid):
    """Check a list of responses and return boolean."""
    statuses = self.getJenkinsBuildStatus(pipeline, uuid)
    running = False
    for status in statuses:
        if status['status'] == 'RUNNING':
            running = True
    return running
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.checkUUIDInUse">
    <p>def <span class="ident">checkUUIDInUse</span>(</p><p>self, uuid)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a UUID validate if it is in use or not.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.checkUUIDInUse', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.checkUUIDInUse" class="source">
    <pre><code>def checkUUIDInUse(self, uuid):
    """Given a UUID validate if it is in use or not."""
    provider = Azure(
        self.config.credentials['azure'],
        self.config.defaults['resource_group_name'],
        self.config.defaults['storage_account_name']
    )
    uuids = provider.getResources()
    if uuid in uuids:
        return True
    else:
        return False
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.checkVMResources">
    <p>def <span class="ident">checkVMResources</span>(</p><p>self, vmName, resources)</p>
    </div>
    

    
  
    <div class="desc"><p>Given a VM Name does it have the right resources.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.checkVMResources', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.checkVMResources" class="source">
    <pre><code>def checkVMResources(self, vmName, resources):
    """Given a VM Name does it have the right resources."""
    vm = dict()
    vm['vm'] = False
    vm['nic'] = False
    vm['pip'] = False
    vm['disks'] = False
    vm['name'] = vmName
    for resource in resources:
        if resource['type'] == "Microsoft.Compute/virtualMachines"\
                and vmName in resource['name']:
                if resource['provisioningState'] == 'Succeeded':
                    vm['vm'] = True
                disks = list()
                for disk in resource['disks']:
                    if 'succeeded' in disk['provisioningState']:
                        disks.append(True)
                    else:
                        disks.append(False)
                if all(disks):
                    vm['disks'] = True
        if resource['type'] == "Microsoft.Network/networkInterfaces"\
                and vmName in resource['name']:
                vm['nic'] = True
        if resource['type'] == "Microsoft.Network/publicIPAddresses"\
                and vmName in resource['name']:
                vm['pip'] = True
    return vm
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.compareResources">
    <p>def <span class="ident">compareResources</span>(</p><p>self, statusRes, deploymentRes, uuid)</p>
    </div>
    

    
  
    <div class="desc"><p>Compare a status list with the Deployment resources.</p>
<p>Loop through the expected resources (deploymnetRes) and ensure at least
one of each is found in the statusRes so we inform the request if all
resources are 'okay' or not.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.compareResources', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.compareResources" class="source">
    <pre><code>def compareResources(self, statusRes, deploymentRes, uuid):
    """Compare a status list with the Deployment resources.
    Loop through the expected resources (deploymnetRes) and ensure at least
    one of each is found in the statusRes so we inform the request if all
    resources are 'okay' or not.
    """
    deployNetworkCount = list()
    for resource in deploymentRes['resources']:
        if 'networks' in resource:
            for network in resource['networks']:
                deployNetworkCount.append(network['name'])
    statusNetworkCount = list()
    statusVmCount = list()
    for i in statusRes:
        if "Environment resources" in i:
            for resource in i["Environment resources"]:
                if resource['type'] == "Microsoft.Network/virtualNetworks":
                    statusNetworkCount.append(resource['name'])
                if resource['type'] == "Microsoft.Compute/virtualMachines":
                    statusVmCount.append(self.checkVMResources(
                            resource['name'],
                            i["Environment resources"]
                        )
                    )
    # Create a list of all of the broken resources so they can be eaisly
    # displayed within the status response.
    brokenResources = list()
    for vm in statusVmCount:
        # If a VM Does not have these it is not 'good'
        if not (vm['vm'] and vm['nic'] and vm['pip'] and vm['disks']):
            print("VM {} is broken".format(vm['name']))
            brokenResources.append({
                'name': vm['name'],
                'type': "Microsoft.Compute/virtualMachines",
                'status': "Failed"
            })
    for network in deployNetworkCount:
        for statusNetwork in statusNetworkCount:
            if network not in statusNetwork:
                brokenResources.append({
                    'name': network,
                    'type': "Microsoft.Network/virtualNetworks",
                    'status': "Failed"
                })
    return brokenResources
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.createEnvironment">
    <p>def <span class="ident">createEnvironment</span>(</p><p>self, data)</p>
    </div>
    

    
  
    <div class="desc"><p>Create an Environment.</p>
<p>From a Infrastructure template create an environment.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.createEnvironment', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.createEnvironment" class="source">
    <pre><code>def createEnvironment(self, data):
    """Create an Environment.
    From a Infrastructure template create an environment.
    """
    if 'infrastructureTemplateID' in data:
        template = self.templates.loadTemplate(
            data['infrastructureTemplateID']
        )
    else:
        raise Exception({
            'error': 'infrastructureTemplateID must be provided',
            'code': 400
        })
    if 'id' in data:
        if Helpers.validString(data['id']):
            if self.checkUUIDInUse(data['id']):
                raise Exception({'error': 'UUID in use', 'code': 412})
        else:
            raise Exception({
                'error': 'UUID is not valid, must be [a-z0-9-]',
                'code': 412
            })
    else:
        raise Exception({'error': 'ID must be provided', 'code': 400})
    if 'application' in data:
        # This should never happen as the check for UUID should throw first
        if self.checkJenkinsRunning(data['application'], data['id']):
            raise Exception({
                'error': 'Jenkins build running already',
                'code': 409
            })
    response = list()
    self.tags['uuid'] = data['id']
    provider = Azure(
        self.config.credentials['azure'],
        self.config.defaults['resource_group_name'],
        self.config.defaults['storage_account_name'],
        template,
        data['id']
    )
    if 'error' in provider.credentials:
        raise Exception({
            'error': provider.credentials['error'],
            'code': 400}
        )
    buildMap = {
        "servers": self.createVms,
        "networks": self.createNetworks,
        "load_balancers": self.createLoadBalancers,
        "tags": self.setTags
    }
    # Build core resources
    print("Creating RG")
    provider.createResourceGroup()
    print("Creating SA")
    provider.createStorageAccount()
    try:
        for resource in provider.resources['resources']:
            for k, v in resource.items():
                if k in buildMap:
                    if k == 'tags':
                        buildMap[k](v)
                    else:
                        buildMap[k](v, provider)
                    continue
    except:
        raise
    for vmRsp in self.vms:
        response.append(vmRsp)
    # By this point an environment should be created so Execute Jenkins job
    if 'application' in data:
        self.runJenkinsPipeline(data['application'])
        if 'gitlab' in data:
            glResponse = self.runGitlabTasks(
                data['gitlab'],
                data['application']
            )
            response.append({'gitlab': glResponse})
    if self.lbs:
        response.append({'loadBalancers': self.lbs})
    return {'msg': {'Resources': response}, 'code': 201}
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.createLoadBalancer">
    <p>def <span class="ident">createLoadBalancer</span>(</p><p>self, lbName, lbDetails, provider, lbQueue, errors)</p>
    </div>
    

    
  
    <div class="desc"><p>Create One loadbalancer and it's dependent Servers.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.createLoadBalancer', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.createLoadBalancer" class="source">
    <pre><code>def createLoadBalancer(self, lbName, lbDetails, provider, lbQueue, errors):
    """Create One loadbalancer and it's dependent Servers."""
    # Create LB here
    try:
        print("Creating LB: {}".format(lbName))
        lbData = provider.loadBalancer(
            lbDetails['load_balancer'],
            self.tags
        )
        lbDetails['servers']['beId'] = lbData['lbInfo'] \
            .backend_address_pools[0].id
        # Create a single item list so we can re-use createVms
        serverList = list()
        serverList.append(lbDetails['servers'])
        self.createVms(serverList, provider)
        record = self.tags['uuid']
        if 'domain' in lbDetails['load_balancer']:
            record = lbDetails['load_balancer']['domain'] + '-' + record
        else:
            record = lbDetails['load_balancer']['name'] + '-' + record
        result = provider.addDNS(
            lbData['publicIp'].ip_address,
            record
        )
        for vm in self.vms:
            if vm['servers'] == lbDetails['load_balancer']['be_servers']:
                lbQueue.put({
                    lbDetails['load_balancer']['name']: result,
                    'vms': vm
                })
    except Exception as e:
        print("Error creating LB {}".format(str(e)))
        errors.put(Exception(e))
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.createLoadBalancers">
    <p>def <span class="ident">createLoadBalancers</span>(</p><p>self, data, provider)</p>
    </div>
    

    
  
    <div class="desc"><p>Create Load balancers.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.createLoadBalancers', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.createLoadBalancers" class="source">
    <pre><code>def createLoadBalancers(self, data, provider):
    """Create Load balancers."""
    print("Creating Load Balancers")
    lbQueue = Queue()
    errors = Queue()
    lbProcList = list()
    try:
        for item in data:
            for lbName, details in item.items():
                # For each LB Spawn a child process
                if self.validateLoadBalancer(details['load_balancer']):
                    p = Process(
                        target=self.createLoadBalancer,
                        args=(lbName, details, provider, lbQueue, errors)
                    )
                    lbProcList.append(p)
                    p.start()
        for proc in lbProcList:
            try:
                proc.join(600)
            except:
                proc.terminate()
                raise
            if not errors.empty():
                # If it's not empty there's an error
                raise {
                    'error': "Error in child process for LB: {}"
                    .format(errors.get()),
                    'code': 500
                }
            if lbQueue.empty():
                raise Exception({
                    'error': "Time out creating LB",
                    'code': 500
                })
            else:
                tmpData = lbQueue.get()
                self.lbs.append(tmpData)
    except Exception as e:
        if e.args[0] is dict:
            raise Exception(e)
        else:
            raise Exception({
                'error': "Unknown error while creating LBs: {}"
                .format(str(e))
            })
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.createNetworks">
    <p>def <span class="ident">createNetworks</span>(</p><p>self, data, provider)</p>
    </div>
    

    
  
    <div class="desc"><p>Create Networks.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.createNetworks', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.createNetworks" class="source">
    <pre><code>def createNetworks(self, data, provider):
    """Create Networks."""
    # Must complete before everything else is built
    subNets = Queue()
    errors = Queue()
    print("Creating network")
    netProcs = list()
    try:
        for idx, network in enumerate(data):
            netId = str(self.tags['uuid'])+network['name']+str(idx)
            p = Process(
                target=provider.network,
                args=(network, netId, self.tags, subNets, errors)
            )
            netProcs.append(p)
            p.start()
        subnets = dict()
        for proc in netProcs:
            try:
                proc.join(600)
            except:
                proc.terminate()
                raise
            if not errors.empty():
                # If it's not empty there's an error
                raise Exception({
                    'error': "Error in child process for networking: {}"
                    .format(errors.get()),
                    'code': 500
                })
            if subNets.empty():
                raise Exception({
                    'error': "Time out creating network",
                    'code': 500
                })
            else:
                subnets['subnets'] = subNets.get()
    except Exception as e:
        if e.args[0] is dict:
            raise Exception(e)
        else:
            raise Exception({
                'error': "Unknown error while creating networks: {}"
                .format(str(e))
            })
    self.subnets.append(subnets)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.createVms">
    <p>def <span class="ident">createVms</span>(</p><p>self, data, provider, persistData=False)</p>
    </div>
    

    
  
    <div class="desc"><p>Create VMs.</p>
<p>For a given set of data, for each 'server' group create each server
with all of dependencies each VM needs.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.createVms', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.createVms" class="source">
    <pre><code>def createVms(self, data, provider, persistData=False):
    """Create VMs.
    For a given set of data, for each 'server' group create each server
    with all of dependencies each VM needs.
    """
    print("Creating Servers")
    vms = Queue()
    errors = Queue()
    vmLock = Lock()
    # Processes that can be run in parrallel
    serverProcs = list()
    try:
        for i in self.subnets:
            if self.tags['uuid'] in i['subnets']:
                # Grab A subnet - needs reworking when multiple networks is
                # supported
                vmSubnet = i['subnets'][self.tags['uuid']]
        for server in data:
            # For each 'server' Spawn a process to create that vm
            p = Process(
                target=provider.virtualMachine,
                args=(
                    server,
                    self.tags,
                    vmSubnet,
                    vms,
                    vmLock,
                    errors,
                    persistData
                )
            )
            vmDetails = {
                'servers': server['name'],
                'process': p
            }
            if 'dns' in server:
                vmDetails['dns'] = server['dns']
            serverProcs.append(vmDetails)
            p.start()
        for proc in serverProcs:
            try:
                proc['process'].join(600)
            except:
                proc['process'].terminate()
                raise
            if not errors.empty():
                # If it's not empty there's an error
                print("Errors not empty")
                raise Exception({
                    'error': "Error in child process for VM: {}"
                    .format(errors.get()),
                    'code': 500
                })
            if vms.empty():
                print("vms empty")
                raise Exception({
                    'error': "Time out creating VMs",
                    'code': 500
                })
            else:
                tmpData = vms.get()
                if 'dns' in proc:
                    # Only apply to the first server
                    result = provider.addDNS(
                        tmpData['vms'][0]['public_ip'],
                        proc['dns'] + '-' + self.tags['uuid']
                    )
                    tmpData['dns'] = result
                self.vms.append(tmpData)
    except Exception as e:
        if e.args[0] is dict:
            raise Exception(e)
        else:
            raise Exception({
                'error': "Unknown error while creating Vms: {}"
                .format(str(e))
            })
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.deleteEnvironment">
    <p>def <span class="ident">deleteEnvironment</span>(</p><p>self, data)</p>
    </div>
    

    
  
    <div class="desc"><p>Delete a specific Environments Resources.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.deleteEnvironment', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.deleteEnvironment" class="source">
    <pre><code>def deleteEnvironment(self, data):
    """Delete a specific Environments Resources."""
    if not self.checkUUIDInUse(data['uuid']):
        raise Exception({'error': 'Invalid UUID', 'code': 404})
    provider = Azure(
        self.config.credentials['azure'],
        self.config.defaults['resource_group_name'],
        self.config.defaults['storage_account_name']
    )
    print("Deleting Resources")
    deleteResources = {'Azure': provider.getResources(data['uuid'])}
    glServerConn = self.config.credentials['gitlab']['url']
    glServerToken = self.config.credentials['gitlab']['token']
    glServer = Gitlab(glServerConn, glServerToken)
    user = glServer.getUser(data['uuid'])
    if user:
        deleteResources['Gitlab'] = user
    if "ids" in deleteResources["Azure"]:
        provider.deleteResourceById(deleteResources["Azure"]["ids"])
    if "vhds" in deleteResources["Azure"]:
        provider.deleteStorageAccountContainer(data['uuid'])
    if "dns" in deleteResources["Azure"]:
        provider.deleteDNSRecord(deleteResources["Azure"]["dns"])
    if "Gitlab" in deleteResources:
        glServer.deleteUser(user)
    return {'code': 204, 'msg': None}
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.environmentServerStopStart">
    <p>def <span class="ident">environmentServerStopStart</span>(</p><p>self, data, action)</p>
    </div>
    

    
  
    <div class="desc"><p>Stop or Start an environment.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.environmentServerStopStart', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.environmentServerStopStart" class="source">
    <pre><code>def environmentServerStopStart(self, data, action):
    """Stop or Start an environment."""
    if not self.checkUUIDInUse(data['uuid']):
        raise Exception({'error': 'Invalid UUID', 'code': 404})
    if 'application' in data:
        if self.checkJenkinsRunning(data['application'], data['uuid']):
            raise Exception({
                'error': 'Jenkins build running already',
                'code': 409
            })
    provider = Azure(
        self.config.credentials['azure'],
        self.config.defaults['resource_group_name'],
        self.config.defaults['storage_account_name'],
        id=data['uuid']
    )
    VMList = self.getVmList(provider, data['uuid'], data['servers'])
    outcome = {
        'stop': 'VM running',
        'start': 'VM stopped'
    }
    actions = {
        'stop': self.stopVM,
        'start': self.startVM
    }
    for vm in VMList:
        if vm['status'] == outcome[action]:
            actions[action](provider, vm)
    statuses = self.getVmList(provider, data['uuid'], data['servers'])
    return {'msg': {'VMs': statuses}, 'code': 200}
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.environmentStatus">
    <p>def <span class="ident">environmentStatus</span>(</p><p>self, data)</p>
    </div>
    

    
  
    <div class="desc"><p>Get the status of an environment.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.environmentStatus', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.environmentStatus" class="source">
    <pre><code>def environmentStatus(self, data):
    """Get the status of an environment."""
    if 'infrastructureTemplateID' in data:
        template = self.templates.loadTemplate(
            data['infrastructureTemplateID']
        )
    else:
        raise Exception({
            'error': 'infrastructureTemplateID must be provided',
            'code': 400
        })
    if 'uuid' in data:
        if not self.checkUUIDInUse(data['uuid']):
            raise Exception({'error': 'Invalid UUID', 'code': 404})
    else:
        raise Exception({'error': 'ID must be provided', 'code': 400})
    statusResoures = list()
    provider = Azure(
        self.config.credentials['azure'],
        self.config.defaults['resource_group_name'],
        self.config.defaults['storage_account_name'],
        template,
        data['uuid']
    )
    print("Getting Status")
    deploymentResources = provider.resources
    resources = provider.getResources(id=data['uuid'])
    if 'ids' in resources:
        statusResoures.append({
            'Environment resources':
            self.getStatusById(resources['ids'], provider)
        })
    if 'dns' in resources:
        dnsEntry = list()
        for entry in resources['dns']:
            dnsEntry.append({
                'name': entry,
                'type': 'Microsoft.Network/dnsZones',
                'status': 'Succeeded'
            })
        statusResoures.append({'Shared resources': dnsEntry})
    if 'vhds' in resources:
        vhdEntry = list()
        for vhd in resources['vhds']:
            vhdEntry.append({
                'name': vhd,
                'type': 'Microsoft.Stroage/blobStorage',
                'status': 'Succeeded'
            })
        statusResoures.append({
            'Storage resources': vhdEntry
        })
    if 'application' in data:
        jenkinsStatus = self.getJenkinsBuildStatus(
            data['application'],
            data['uuid']
        )
        statusResoures.append({
            'Build resources': jenkinsStatus
        })
    broken = self.compareResources(
        statusResoures,
        deploymentResources,
        data['uuid']
    )
    response = {
        'Resources': statusResoures,
        'status': "Succeeded"
    }
    if broken:
        statusResoures.append({
            'Broken resources': broken
        })
        response['status'] = "Failed"
    return {'msg': response, 'code': 200}
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.getJenkinsBuildStatus">
    <p>def <span class="ident">getJenkinsBuildStatus</span>(</p><p>self, pipeline, uuid)</p>
    </div>
    

    
  
    <div class="desc"><p>Get a pipeline status for a given uuid.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.getJenkinsBuildStatus', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.getJenkinsBuildStatus" class="source">
    <pre><code>def getJenkinsBuildStatus(self, pipeline, uuid):
    """Get a pipeline status for a given uuid."""
    jenkinsServer = Jenkins(
        self.config.credentials['jenkins']['url'],
        user=self.config.credentials['jenkins']['user'],
        password=self.config.credentials['jenkins']['password']
    )
    status = jenkinsServer.getBuildStatus(
        pipeline,
        uuid
    )
    return status
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.getResourceDetails">
    <p>def <span class="ident">getResourceDetails</span>(</p><p>self, id)</p>
    </div>
    

    
  
    <div class="desc"><p>Get a VM object back from an ID.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.getResourceDetails', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.getResourceDetails" class="source">
    <pre><code>def getResourceDetails(self, id):
    """Get a VM object back from an ID."""
    resource = dict()
    resource['id'] = id
    idSplit = re.split(r"/", id.strip())
    resource['name'] = idSplit[-1]
    resource['type'] = idSplit[6] + "/" + idSplit[7]
    resource['group'] = idSplit[4]
    return resource
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.getStatusById">
    <p>def <span class="ident">getStatusById</span>(</p><p>self, ids, provider)</p>
    </div>
    

    
  
    <div class="desc"><p>Get the status of a resource.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.getStatusById', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.getStatusById" class="source">
    <pre><code>def getStatusById(self, ids, provider):
    """Get the status of a resource."""
    statuses = list()
    for id in ids:
        details = self.getResourceDetails(id)
        item = provider.getResourceById(details['type'], details['id'])
        if 'provisioningState' in item.properties:
            tmpItem = {
                'name': details['name'],
                'type': details['type'],
                'resourceGroup': details['group'],
                'provisioningState': item.properties['provisioningState']
            }
            if item.type == "Microsoft.Compute/virtualMachines":
                vmData = provider.getVmInfo(
                    item.name,
                    item.id,
                    details['group']
                )
                for status in vmData.instance_view.statuses:
                    if 'PowerState' in status.code:
                        tmpItem['status'] = status.display_status
                disks = list()
                for disk in vmData.instance_view.disks:
                    for status in disk.statuses:
                        disks.append({
                            "name": disk.name,
                            "provisioningState": status.display_status
                        })
                tmpItem['disks'] = disks
        else:
            if details['type'] == 'Microsoft.Compute/availabilitySets':
                tmpItem = {
                    'name': details['name'],
                    'type': details['type'],
                    'resourceGroup': details['group'],
                    'provisioningState': 'Succeeded'
                }
            else:
                tmpItem = {
                    'name': details['name'],
                    'type': details['type'],
                    'resourceGroup': details['group'],
                    'provisioningState': 'Unknown'
                }
        statuses.append(tmpItem)
    return statuses
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.getTemplate">
    <p>def <span class="ident">getTemplate</span>(</p><p>self, templateName)</p>
    </div>
    

    
  
    <div class="desc"><p>Get a Template by Name.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.getTemplate', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.getTemplate" class="source">
    <pre><code>def getTemplate(self, templateName):
    """Get a Template by Name."""
    return self.templates.loadTemplate(templateName)
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.getVMBEID">
    <p>def <span class="ident">getVMBEID</span>(</p><p>self, provider, id=None, template=None, server=None, uuid=None)</p>
    </div>
    

    
  
    <div class="desc"><p>For an ID get the BE ID.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.getVMBEID', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.getVMBEID" class="source">
    <pre><code>def getVMBEID(
        self, provider, id=None, template=None,
        server=None, uuid=None
        ):
    """For an ID get the BE ID."""
    beId = None
    if template and uuid and server:
        if 'load_balancers' in template['services']:
            for lb in template['services']['load_balancers']:
                if lb['be_servers'] == server:
                    lbName = lb['name']
                    resources = provider.getResources(id=uuid)
                    for id in resources['ids']:
                        idSplit = re.split(r"/", id.strip())
                        resourceType = idSplit[6] + "/" + idSplit[7]
                        resourceName = idSplit[-1]
                        lbResName = 'Microsoft.Network/loadBalancers'
                        if resourceType == lbResName and \
                                lbName in resourceName:
                            print("Getting LB")
                            # Found the Id of the Load balancer
                            # for the server
                            lb = provider.getResourceById(resourceType, id)
                            be = lb.properties['backendAddressPools'][0]
                            beId = be['id']
    return beId
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.getVMDetails">
    <p>def <span class="ident">getVMDetails</span>(</p><p>self, id, server)</p>
    </div>
    

    
  
    <div class="desc"><p>Get a VM object back from an ID.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.getVMDetails', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.getVMDetails" class="source">
    <pre><code>def getVMDetails(self, id, server):
    """Get a VM object back from an ID."""
    vm = dict()
    vm['id'] = id
    idSplit = re.split(r"/", id.strip())
    vm['name'] = idSplit[-1]
    vm['type'] = idSplit[6] + "/" + idSplit[7]
    vm['server'] = server
    countSplit = re.split(r"{}".format(type), vm['name'].strip())
    vm['position'] = countSplit[-1]
    return vm
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.getVmList">
    <p>def <span class="ident">getVmList</span>(</p><p>self, provider, uuid, server)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a list of VM's and their current running state.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.getVmList', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.getVmList" class="source">
    <pre><code>def getVmList(self, provider, uuid, server):
    """Return a list of VM's and their current running state."""
    resources = provider.getResources(id=uuid, filter={
        'key': 'type',
        'value': server
    })
    if 'ids' in resources:
        statuses = self.getStatusById(resources['ids'], provider)
        return statuses
    else:
        raise Exception({
            'error': "No VM Resources found for {} in {}".format(
                server,
                uuid
            ),
            'code': 404
        })
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.listEnvironments">
    <p>def <span class="ident">listEnvironments</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Return a list of environments.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.listEnvironments', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.listEnvironments" class="source">
    <pre><code>def listEnvironments(self):
    """Return a list of environments."""
    provider = Azure(
        self.config.credentials['azure'],
        self.config.defaults['resource_group_name'],
        self.config.defaults['storage_account_name']
    )
    return {'msg': {"Environments": provider.getResources()}, 'code': 200}
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.rebuildEnvironmentServer">
    <p>def <span class="ident">rebuildEnvironmentServer</span>(</p><p>self, data)</p>
    </div>
    

    
  
    <div class="desc"><p>Rebuild a portion of an environment.</p>
<p>Given a specified 'server' group delete and recreate those servers.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.rebuildEnvironmentServer', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.rebuildEnvironmentServer" class="source">
    <pre><code>def rebuildEnvironmentServer(self, data):
    """Rebuild a portion of an environment.
    Given a specified 'server' group delete and recreate those servers.
    """
    if 'infrastructureTemplateID' in data:
        template = self.templates.loadTemplate(
            data['infrastructureTemplateID']
        )
        templateCopy = deepcopy(template)
    else:
        raise Exception({
            'error': 'infrastructureTemplateID must be provided',
            'code': 400
        })
    if 'uuid' in data:
        if not self.checkUUIDInUse(data['uuid']):
            raise Exception({'error': 'Invalid UUID', 'code': 404})
    else:
        raise Exception({'error': 'ID must be provided', 'code': 400})
    if 'application' in data:
        if self.checkJenkinsRunning(data['application'], data['uuid']):
            raise Exception({
                'error': 'Jenkins build running already',
                'code': 409
            })
    response = list()
    provider = Azure(
        self.config.credentials['azure'],
        self.config.defaults['resource_group_name'],
        self.config.defaults['storage_account_name'],
        template,
        data['uuid']
    )
    print("Rebuilding: {}".format(data['servers']))
    resources = provider.getResources(id=data['uuid'], filter={
        'key': 'type',
        'value': data['servers']
    })
    vmDetails = list()
    if 'ids' in resources:
        for vm in resources['ids']:
            vmDetails.append(self.getVMDetails(vm, data['servers']))
        # Delete Resources
        provider.deleteResourceById(resources['ids'])
    else:
        vmDetails.append({'type': data['servers']})
    persistData = False
    if 'vhds' in resources:
        if data["persistData"]:
            persistData = data['persistData']
            # Delete OS Disks
            delDisks = list()
            for disk in resources['vhds']:
                if 'data' not in disk:
                    delDisks.append(disk)
            if delDisks:
                provider.deleteStorageAccountDisk(data['uuid'], delDisks)
        else:
            print("persistData False")
            # Delete All Disks
            provider.deleteStorageAccountDisk(
                data['uuid'],
                resources['vhds']
            )
    count = None
    if 'ids' in resources:
        count = len(resources['ids'])
    self.addVM(
        vmDetails,
        provider,
        templateCopy,
        data['uuid'],
        data['application'],
        count=count,
        persistData=persistData
    )
    for vmRsp in self.vms:
        response.append(vmRsp)
    return {'msg': {'Resources': response}, 'code': 200}
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.runGitlabTasks">
    <p>def <span class="ident">runGitlabTasks</span>(</p><p>self, gitlab, app)</p>
    </div>
    

    
  
    <div class="desc"><p>Run the required actrions for Gitlab creation.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.runGitlabTasks', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.runGitlabTasks" class="source">
    <pre><code>def runGitlabTasks(self, gitlab, app):
    """Run the required actrions for Gitlab creation."""
    response = dict()
    print("Connecting to Gitlab")
    glServerConn = self.config.credentials['gitlab']['url']
    glServerToken = self.config.credentials['gitlab']['token']
    glSourceTeam = "root"
    glServer = Gitlab(glServerConn, glServerToken)
    print("Create user")
    password = Helpers.randStr(10)
    if 'password' in gitlab['user']:
        password = gitlab['user']['password']
    user = glServer.createUser(
        self.tags['uuid'],
        self.tags['uuid'],
        password,
        self.tags['uuid'] + '@example.net'
    )
    print("Adding SSH key for User")
    if 'sshKey' in gitlab['user']:
        key = glServer.addSshKey(user, gitlab['user']['sshKey'])
        if type(key) is dict:
            if 'error' in key:
                raise Exception(key)
    response['user'] = user.username
    print("Cloning Repos")
    if 'cloneRepos' in gitlab:
        response['repos'] = dict()
        for repo in gitlab['cloneRepos']:
            glSourceProject = glServer.getProject(glSourceTeam, repo)
            if type(glSourceProject) is dict:
                if 'error' in glSourceProject:
                    raise Exception(glSourceProject)
            forked = glServer.forkProject(
                user.username,
                glSourceProject.id
            )
            if type(forked) is dict:
                if 'error' in forked:
                    raise Exception(forked)
            print("Getting the SSH url for the repo")
            response['repos'][repo] = {
                'ssh': forked.ssh_url_to_repo,
                'web': forked.http_url_to_repo
            }
            print("Granting access to forked repo")
            member = glServer.addUserToProjectMembers(user, forked)
            if type(member) is dict:
                if 'error' in member:
                    raise Exception(member)
            print("Hooking it up")
            hook = glServer.addHook(
                self.config.credentials['jenkins']['url'] +
                "/project/{}/".format(app),
                forked
            )
            if type(hook) is dict:
                if 'error' in hook:
                    raise Exception(hook)
    return response
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.runJenkinsPipeline">
    <p>def <span class="ident">runJenkinsPipeline</span>(</p><p>self, pipeline)</p>
    </div>
    

    
  
    <div class="desc"><p>Run a specified Jenkins pipeline.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.runJenkinsPipeline', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.runJenkinsPipeline" class="source">
    <pre><code>def runJenkinsPipeline(self, pipeline):
    """Run a specified Jenkins pipeline."""
    jenkinsServer = Jenkins(
        self.config.credentials['jenkins']['url'],
        user=self.config.credentials['jenkins']['user'],
        password=self.config.credentials['jenkins']['password']
    )
    print("Running Jenkins Job")
    jenkinsServer.runBuildWithParams(
        pipeline,
        params={
            "UUID": self.tags['uuid']
        }
    )
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.scaleEnvironmentServer">
    <p>def <span class="ident">scaleEnvironmentServer</span>(</p><p>self, data)</p>
    </div>
    

    
  
    <div class="desc"><p>Scale an Environments servers.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.scaleEnvironmentServer', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.scaleEnvironmentServer" class="source">
    <pre><code>def scaleEnvironmentServer(self, data):
    """Scale an Environments servers."""
    if 'infrastructureTemplateID' in data:
        template = self.templates.loadTemplate(
            data['infrastructureTemplateID']
        )
        templateCopy = deepcopy(template)
    else:
        raise Exception({
            'error': 'infrastructureTemplateID must be provided',
            'code': 400
        })
    if 'uuid' in data:
        if not self.checkUUIDInUse(data['uuid']):
            raise Exception({'error': 'Invalid UUID', 'code': 404})
    else:
        raise Exception({'error': 'ID must be provided', 'code': 400})
    if 'application' in data:
        if self.checkJenkinsRunning(data['application'], data['uuid']):
            raise Exception({
                'error': 'Jenkins build running already',
                'code': 409
            })
    response = list()
    provider = Azure(
        self.config.credentials['azure'],
        self.config.defaults['resource_group_name'],
        self.config.defaults['storage_account_name'],
        template,
        data['uuid']
    )
    resources = provider.getResources(id=data['uuid'], filter={
        'key': 'type',
        'value': data['servers']
    })
    currentSize = 0
    vms = list()
    if 'ids' in resources:
        currentSize = len(resources['ids'])
        for vm in resources['ids']:
            vms.append(self.getVMDetails(vm, data['servers']))
    else:
        vms.append({'server': data['servers']})
    response.append(vms)
    print("Scalling: {} from {} to {}".format(
        data['servers'],
        currentSize,
        data['count']
    ))
    if currentSize < data['count']:
        # Scale up
        self.addVM(
            vms,
            provider,
            templateCopy,
            data['uuid'],
            data['application'],
            count=data['count']
        )
    elif currentSize > data['count']:
        # Scale down
        deleteIds = list()
        deleteDisks = list()
        while len(vms) > data['count']:
            deleteIds.append(vms[-1]['id'])
            for disk in resources['vhds']:
                if vms[-1]['name'] in disk:
                    deleteDisks.append(disk)
            vms.remove(vms[-1])
        provider.deleteResourceById(deleteIds)
        provider.deleteStorageAccountDisk(
            data['uuid'],
            deleteDisks
        )
    for vmRsp in self.vms:
        response.append(vmRsp)
    return {'msg': {'Resources': response}, 'code': 200}
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.setTags">
    <p>def <span class="ident">setTags</span>(</p><p>self, data)</p>
    </div>
    

    
  
    <div class="desc"><p>Create the tags property.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.setTags', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.setTags" class="source">
    <pre><code>def setTags(self, data):
    """Create the tags property."""
    print("Creating Tags")
    self.tags = {**self.tags, **data}
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.startVM">
    <p>def <span class="ident">startVM</span>(</p><p>self, provider, vm)</p>
    </div>
    

    
  
    <div class="desc"><p>Start a stopped VM.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.startVM', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.startVM" class="source">
    <pre><code>def startVM(self, provider, vm):
    """Start a stopped VM."""
    provider.startVm(vm['name'], vm['resourceGroup'])
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.stopVM">
    <p>def <span class="ident">stopVM</span>(</p><p>self, provider, vm)</p>
    </div>
    

    
  
    <div class="desc"><p>Stop a running VM.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.stopVM', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.stopVM" class="source">
    <pre><code>def stopVM(self, provider, vm):
    """Stop a running VM."""
    provider.stopVm(vm['name'], vm['resourceGroup'])
</code></pre>
  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="platforminfra.controller.Controller.validateLoadBalancer">
    <p>def <span class="ident">validateLoadBalancer</span>(</p><p>self, lb)</p>
    </div>
    

    
  
    <div class="desc"><p>Validate a LB's config.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-platforminfra.controller.Controller.validateLoadBalancer', this);">Show source &equiv;</a></p>
  <div id="source-platforminfra.controller.Controller.validateLoadBalancer" class="source">
    <pre><code>def validateLoadBalancer(self, lb):
    """Validate a LB's config."""
    validate = False
    if lb['health_protocol'] == 'Tcp' or \
            lb['health_protocol'] == 'Http':
        if lb['health_protocol'] == 'Http':
            if 'health_path' not in lb:
                e = {
                    'error': "Must specify health_path with Http"
                }
                raise Exception(e)
        validate = True
    else:
        e = {
            'error': "health_protocol must be 'Http' or 'Tcp'"
        }
        raise Exception(e)
    return validate
</code></pre>
  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="platforminfra.controller.Controller.config" class="name">var <span class="ident">config</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="platforminfra.controller.Controller.lbs" class="name">var <span class="ident">lbs</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="platforminfra.controller.Controller.subnets" class="name">var <span class="ident">subnets</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="platforminfra.controller.Controller.tags" class="name">var <span class="ident">tags</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="platforminfra.controller.Controller.templates" class="name">var <span class="ident">templates</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="platforminfra.controller.Controller.vms" class="name">var <span class="ident">vms</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
